# Genealogy 組件說明

## 總覽

繫絡圖組件用於可視化輸入法發展歷史和演化關係。

- **時間軸**：左側顯示年份，從上到下表示時間推移
- **卡片**：每個卡片代表一個輸入法，顯示名稱、作者、維護者和發布時間
- **關注模式**：點擊卡片進入關注模式，查看該輸入法的詳細信息和源流關係
- **篩選功能**：使用頂部篩選器按方案、作者或特征快速定位
- **連接交互**：在關注模式下，可以 hover 或點擊連線來強調或釘選連接關係
- **時間軸反轉**：點擊 ⇅ 按鈕可以反轉時間軸方向

## 功能特性

::: info 當前進度
✅ 數據加載和解析  
✅ 基礎佈局和時間軸  
✅ **智能佈局算法（防重疊）**  
✅ **動態時間軸間距（空間節省 85%）**  
✅ **空白段壓縮算法（連續空白自動壓縮）**  
✅ **智能年份標籤（壓縮率 53%）**  
✅ **自動分組和橫向分佈**  
✅ **連接關係計算**  
✅ **貝塞爾曲線連接線**  
✅ **特性/作者繼承可視化**  
✅ **相似方案檢測（高度相似連接）**  
✅ **維護者字段支持**  
✅ **搜索和篩選功能**  
✅ **關注模式互動**  
✅ **連接線交互（hover/click）**  
✅ **性能優化（預計算渲染緩存）**  
:::

### 智能佈局算法

繫絡圖採用了先進（狗頭保命）的智能佈局算法，確保輸入法卡片清晰可見、不會重疊：

1. **緊湊卡片**
   - 基本格式：**輸入法名** 作者名 年份
   - 如有維護者：維護者單獨顯示於作者上方一行
   - 卡片高度為 40px（無維護者）或 54px（有維護者）
   - 視覺清爽，可容納更多信息

2. **動態時間軸間距**：根據每年的輸入法數量智能調整間距
   - 有輸入法的年份：自動擴展高度（35px，緊湊單行卡片）
   - 短空白期（<3年）：正常間距（15px/年）
   - 長空白期（≥3年）：整段壓縮為固定高度（30px）
   - 允許用戶調整 Y 軸縮放比例

3. **智能年份標籤**：空白段只顯示起始、結束和間隔年份
   - 減少 53% 的標籤數量，保持清晰度
   - 例如：1999-2013年（15年空白期）只顯示 1999、2004、2009、2013

4. **時間軸定位**：根據精確的發布日期（年/月/日）計算Y坐標

5. **智能分組**：將時間相近的輸入法自動分組

6. **橫向分佈**：同一時間段的輸入法均勻分佈，避免擁擠

7. **防重疊檢測**：自動檢測並避免卡片重疊

### 連接關係可視化

繫絡圖會自動計算並展示輸入法之間的三種繼承關係：

#### 特性繼承（實線，藍色）

- 當一個輸入法首次引入某個特性時，它成為該特性的"起源"
- 後續使用該特性的輸入法會用**藍紫色實線**連接到起源
- 例如："最長四碼"特性從五筆開始，後續的鄭碼、徐碼都會連接到五筆

#### 作者繼承（虛線，綠色）

- 當同一作者或維護者創作/維護多個輸入法時，它們會按時間順序連接
- 使用**綠色虛線**（間距 10, 6）表示
- 維護者與原作者在連接判定時視為等同
- 例如：王永民的五筆86版和五筆98版會用綠色虛線連接

#### 相似方案（虛線，橙色）

- 檢測特徵高度相似但非同一作者、非父子關係的輸入法
- 相似條件：特徵差異 ≤ 1 個
- 使用**橙色虛線**（間距 5, 5）表示
- 標籤顯示：
  - 完全相同特徵："高度相似"
  - 多一個特徵："XXX 不同"
  - 各差一個特徵："XXX 對 XXX"
- 關注模式下會高亮相似節點（橙色邊框）

### 交互功能

#### 篩選功能

- **方案篩選**：按輸入法方案名稱篩選
- **作者篩選**：按輸入法作者或維護者篩選（維護者會合併到作者列表）
- **特征篩選**：按輸入法特征篩選
- **智能展開**：篩選時自動顯示完整的父子關係，即使父子節點不在篩選範圍內

#### 關注模式

- **點擊卡片**：進入關注模式，顯示該輸入法的詳細信息和源流關係
- **右下角浮動窗口**：顯示關注節點的詳細信息（名稱、作者、維護者、日期、特征、備註）
- **連接高亮**：只顯示與該輸入法相關的連接
- **節點類型**：父節點（藍色）、子節點（綠色）、相似節點（橙色）
- **連接交互**：在關注模式下，可以鼠標懸停連線來高亮，或點擊連線來釘選
- **再次點擊**：退出關注模式

#### 連接線交互

- **普通模式**：連接線不可交互
- **關注模式**：
  - **懸停強調連線**：鼠標懸停在連線上時高亮顯示
  - **點擊釘選連線**：點擊連線可以釘選，再次點擊取消釘選
  - **只有強調連線**：只有強調的連線（非淡出）可以交互
  - **標籤顯示**：懸停或釘選連線時顯示標籤

### 性能優化

#### 核心優化策略

1. **佈局預計算**：`layoutNodes` 只在數據加載時計算一次
2. **可見性控制**：使用 `v-show` 而非重新計算佈局來控制節點顯示
3. **渲染緩存**：`connectionRenderCache` 預計算所有連接的渲染屬性
4. **CSS 優化**：使用 `contain: layout style paint` 限制重排範圍
5. **無過渡動畫**：無 CSS transitions 以提升性能
6. **碰撞檢測優化**：較少的迭代次數

#### 性能監控

組件內置性能監控，在控制台輸出關鍵操作的耗時：

- 關注模式切換耗時
- 連接數、節點數統計
- 渲染緩存大小

### 配置選項

可以通過 `config` 屬性自定義繫絡圖的行為：

```vue
<Genealogy :config="{
  width: 1024,                  // 畫布寬度（默認 1024px）
  nodeSpacing: 10,              // 卡片間距（默認 10px，緊湊布局）
  baseSpacing: 15,              // 短空白期間距（默認 15px/年）
  schemaSpacing: 35,            // 每個輸入法高度（默認 35px，緊湊）
  emptyYearThreshold: 3,        // 空白段閾值（默認 3年）
  emptySegmentSpacing: 30,      // 空白段總高度（默認 30px）
  labelInterval: 5,             // 空白段標籤間隔（默認 5年）
  showDeprecated: true          // 顯示已停止維護的輸入法
}" />
```

#### 間距參數說明

- **nodeSpacing**：相鄰卡片之間的最小間距（緊湊布局默認 10px）
- **baseSpacing**：短空白期（<閾值）每年的間距（緊湊布局默認 15px）
- **schemaSpacing**：每個輸入法佔用的額外高度（緊湊布局默認 35px）
- **emptyYearThreshold**：連續超過此年數的空白期將被壓縮
  - 設為 3：連續 3 年以上空白會壓縮
  - 設為 999：禁用空白段壓縮
- **emptySegmentSpacing**：長空白段的總高度（無論多少年）
  - 緊湊布局默認 30px（例如：15年空白期也只佔用 30px）
- **labelInterval**：空白段內年份標籤的顯示間隔
  - 設為 5：每 5 年顯示一次標籤
  - 設為 0：只顯示起始和結束年份

#### 效果對比

| 方案                         | 總高度     | 節省空間 | 平均/輸入法 | 卡片高度 |
| ---------------------------- | ---------- | -------- | ----------- | -------- |
| 固定間距（100px/年）         | 4800px     | -        | 600px       | 80px     |
| 動態間距（無壓縮）           | 2100px     | 56.3%    | 263px       | 80px     |
| 空白段壓縮                   | 1200px     | 75.0%    | 150px       | 80px     |
| **緊湊單行布局**（當前推薦） | **~700px** | **~85%** | **~88px**   | **40px** |

## 文件結構

```txt
components/genealogy/
├── Genealogy.vue          # 主組件
├── types.ts               # TypeScript 類型定義
├── dataLoader.ts          # 數據加載和預處理
├── layoutEngine.ts        # 佈局算法引擎
├── connectionEngine.ts    # 連接關係計算
├── connectionRenderer.ts  # 連接線渲染工具
└── readme.md              # 本文檔
```

### 模塊職責

- **Genealogy.vue**：主組件，負責 UI 渲染和交互邏輯
- **types.ts**：定義所有 TypeScript 類型和接口
- **dataLoader.ts**：加載和預處理數據，計算年份間距
- **layoutEngine.ts**：計算節點位置，防重疊
- **connectionEngine.ts**：計算特性和作者繼承關係
- **connectionRenderer.ts**：生成 SVG 連接線路徑
