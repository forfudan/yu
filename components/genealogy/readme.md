# Genealogy 組件說明

## 總覽

源流圖組件用於可視化輸入法發展歷史和演化關係：

- **時間軸**：左側顯示年份，從上到下表示時間推移
- **卡片**：每個卡片代表一個輸入法，顯示名稱、作者和發布時間
- **關注模式**：點擊卡片進入關注模式，查看該輸入法的詳細信息和源流關係
- **篩選功能**：使用頂部篩選器按方案、作者或特征快速定位
- **連接交互**：在關注模式下，可以 hover 或點擊連線來強調或釘選連接關係
- **時間軸反轉**：點擊 ⇅ 按鈕可以反轉時間軸方向

## 功能特性

::: info 當前進度
✅ 數據加載和解析  
✅ 基礎佈局和時間軸  
✅ **智能佈局算法（防重疊）**  
✅ **動態時間軸間距（空間節省 85%）**  
✅ **空白段壓縮算法（連續空白自動壓縮）**  
✅ **智能年份標籤（壓縮率 53%）**  
✅ **自動分組和橫向分佈**  
✅ **佈局質量評分系統**  
✅ **可選的力導向優化**  
✅ **連接關係計算**  
✅ **貝塞爾曲線連接線**  
✅ **特性/作者繼承可視化**  
✅ **搜索和篩選功能**  
✅ **關注模式互動**  
✅ **連接線交互（hover/click）**  
✅ **性能優化（預計算渲染緩存）**  
🚧 響應式優化（開發中）
:::

### 智能佈局算法

源流圖採用了先進的智能佈局算法，確保輸入法卡片清晰可見、不會重疊：

1. **緊湊單行卡片**：將三行信息壓縮為一行
   - 格式：**輸入法名** 作者名 | 年份
   - 卡片高度從 80px 減少到 40px（節省 50%）
   - 視覺更清爽，可容納更多信息

2. **動態時間軸間距**：根據每年的輸入法數量智能調整間距
   - 有輸入法的年份：自動擴展高度（35px，緊湊單行卡片）
   - 短空白期（<3年）：正常間距（15px/年）
   - 長空白期（≥3年）：整段壓縮為固定高度（30px）
   - 空間利用率提升 **85%+**！

3. **智能年份標籤**：空白段只顯示起始、結束和間隔年份
   - 減少 53% 的標籤數量，保持清晰度
   - 例如：1999-2013年（15年空白期）只顯示 1999、2004、2009、2013

4. **時間軸定位**：根據精確的發布日期（年/月/日）計算Y坐標

5. **智能分組**：將時間相近的輸入法自動分組

6. **橫向分佈**：同一時間段的輸入法均勻分佈，避免擁擠

7. **防重疊檢測**：自動檢測並避免卡片重疊

8. **質量評分**：實時計算佈局質量（0-100分）

#### 緊湊布局優勢

- **卡片高度減半**：從 80px → 40px
- **間距優化**：nodeSpacing 15→10, schemaSpacing 50→35
- **空白段壓縮**：emptySegmentSpacing 40→30
- **總體高度**：減少約 85%

#### 空白段壓縮示例

實際數據（1976-2024，緊湊布局）：

- **1987-1997**（11年空白）：220px → 30px（節省 190px）
- **1999-2013**（15年空白）：300px → 30px（節省 270px）
- **2015-2022**（8年空白）：160px → 30px（節省 130px）
- **總計節省**：總高度降至約 **600-700px**

### 連接關係可視化

源流圖會自動計算並展示輸入法之間的繼承關係：

#### 特性繼承（實線）

- 當一個輸入法首次引入某個特性時，它成為該特性的"起源"
- 後續使用該特性的輸入法會用**藍紫色實線**連接到起源
- 例如："最長四碼"特性從鄭碼開始，後續的五筆、徐碼都會連接到鄭碼

#### 作者繼承（虛線）

- 當同一作者創作多個輸入法時，它們會按時間順序連接
- 使用**綠色虛線**表示
- 例如：王永民的五筆86版和五筆98版會用綠色虛線連接

### 交互功能

#### 篩選功能

- **方案篩選**：按輸入法方案名稱篩選
- **作者篩選**：按輸入法作者篩選
- **特征篩選**：按輸入法特征篩選
- **智能展開**：篩選時自動顯示完整的父子關係，即使父子節點不在篩選範圍內

#### 關注模式

- **點擊卡片**：進入關注模式，顯示該輸入法的詳細信息和源流關係
- **右下角浮動窗口**：顯示關注節點的詳細信息（名稱、作者、日期、特征、備註）
- **連接高亮**：只顯示與該輸入法相關的連接
- **父子節點**：父節點（藍色）、子節點（綠色）
- **連接交互**：在關注模式下，可以 hover 連線來高亮，或點擊連線來釘選
- **再次點擊**：退出關注模式

#### 連接線交互

- **普通模式**：連接線不可交互
- **關注模式**：
  - **Hover 強調連線**：鼠標懸停在連線上時高亮顯示
  - **點擊釘選連線**：點擊連線可以釘選，再次點擊取消釘選
  - **只有強調連線**：只有強調的連線（非 dimmed）可以交互
  - **標籤顯示**：hover 或釘選連線時顯示標籤

### 性能優化

#### 核心優化策略

1. **佈局預計算**：`layoutNodes` 只在數據加載時計算一次
2. **可見性控制**：使用 `v-show` 而非重新計算佈局來控制節點顯示
3. **渲染緩存**：`connectionRenderCache` 預計算所有連接的渲染屬性
4. **CSS 優化**：使用 `contain: layout style paint` 限制重排範圍
5. **移除過渡動畫**：刪除 CSS transitions 以提升性能
6. **碰撞檢測優化**：減少迭代次數（20→10）

#### 性能監控

組件內置性能監控，在控制台輸出關鍵操作的耗時：

- 關注模式切換耗時
- 連接數、節點數統計
- 渲染緩存大小

### 佈局優化選項

開啟"優化佈局"選項後，會使用力導向算法進一步優化節點位置：

- 自動調整節點間距
- 減少視覺混亂
- 提升整體美觀度

適合節點較多且分佈密集的情況。

### 配置選項

可以通過 `config` 屬性自定義源流圖的行為：

```vue
<Genealogy :config="{
  width: 1024,                  // 畫布寬度（默認 1024px）
  nodeSpacing: 10,              // 卡片間距（默認 10px，緊湊布局）
  baseSpacing: 15,              // 短空白期間距（默認 15px/年）
  schemaSpacing: 35,            // 每個輸入法高度（默認 35px，緊湊）
  emptyYearThreshold: 3,        // 空白段閾值（默認 3年）
  emptySegmentSpacing: 30,      // 空白段總高度（默認 30px）
  labelInterval: 5,             // 空白段標籤間隔（默認 5年）
  showDeprecated: true          // 顯示已停止維護的輸入法
}" />
```

#### 間距參數說明

- **nodeSpacing**：相鄰卡片之間的最小間距（緊湊布局默認 10px）
- **baseSpacing**：短空白期（<閾值）每年的間距（緊湊布局默認 15px）
- **schemaSpacing**：每個輸入法佔用的額外高度（緊湊布局默認 35px）
- **emptyYearThreshold**：連續超過此年數的空白期將被壓縮
  - 設為 3：連續 3 年以上空白會壓縮
  - 設為 999：禁用空白段壓縮
- **emptySegmentSpacing**：長空白段的總高度（無論多少年）
  - 緊湊布局默認 30px（例如：15年空白期也只佔用 30px）
- **labelInterval**：空白段內年份標籤的顯示間隔
  - 設為 5：每 5 年顯示一次標籤
  - 設為 0：只顯示起始和結束年份

#### 效果對比

| 方案                         | 總高度     | 節省空間 | 平均/輸入法 | 卡片高度 |
| ---------------------------- | ---------- | -------- | ----------- | -------- |
| 固定間距（100px/年）         | 4800px     | -        | 600px       | 80px     |
| 動態間距（無壓縮）           | 2100px     | 56.3%    | 263px       | 80px     |
| 空白段壓縮                   | 1200px     | 75.0%    | 150px       | 80px     |
| **緊湊單行布局**（當前推薦） | **~700px** | **~85%** | **~88px**   | **40px** |

## 文件結構

```
components/genealogy/
├── Genealogy.vue          # 主組件
├── types.ts               # TypeScript 類型定義
├── dataLoader.ts          # 數據加載和預處理
├── layoutEngine.ts        # 佈局算法引擎
├── connectionEngine.ts    # 連接關係計算
├── connectionRenderer.ts  # 連接線渲染工具
└── readme.md             # 本文檔
```

### 模塊職責

- **Genealogy.vue**：主組件，負責 UI 渲染和交互邏輯
- **types.ts**：定義所有 TypeScript 類型和接口
- **dataLoader.ts**：加載和預處理數據，計算年份間距
- **layoutEngine.ts**：計算節點位置，防重疊，佈局優化
- **connectionEngine.ts**：計算特性和作者繼承關係
- **connectionRenderer.ts**：生成 SVG 連接線路徑
