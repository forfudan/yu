<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‡æµ©ç³»åˆ—å­—æ ¹ç·´ç¿’è‡ªå‹•æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: bold;
            color: #555;
        }

        .input-group input,
        .input-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .button.primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button.danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .button.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 90, 82, 0.4);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .progress {
            margin: 20px 0;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.failure {
            color: #dc3545;
        }

        .log-entry.info {
            color: #17a2b8;
        }

        .log-entry.warning {
            color: #ffc107;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .running .stat-card {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title">å®‡æµ©ç³»åˆ—å­—æ ¹ç·´ç¿’è‡ªå‹•æ¸¬è©¦å·¥å…·</h1>
            <p>æ¨¡æ“¬åœ¨çœŸå¯¦ç•Œé¢ä¸­ä¸æ–·å¡«å…¥æ­£ç¢ºæˆ–éŒ¯èª¤ç­”æ¡ˆï¼Œæ¸¬è©¦ç®—æ³•æ˜¯å¦æœƒå¡åœ¨æŸå€‹é€²åº¦ç„¡æ³•æ¨é€²</p>
        </div>

        <div class="controls">
            <div class="input-group">
                <label>ç·´ç¿’ç›®æ¨™</label>
                <input type="number" id="targetPractices" value="2000" min="1" max="10000">
            </div>
            <div class="input-group">
                <label>ç·´ç¿’é€Ÿåº¦</label>
                <select id="speed">
                    <option value="10" selected>æ¥µæ¥µå¿« (10ms)</option>
                    <option value="50">æ¥µå¿« (50ms)</option>
                    <option value="100">å¿«é€Ÿ (100ms)</option>
                    <option value="200">æ­£å¸¸ (200ms)</option>
                    <option value="500">æ…¢é€Ÿ (500ms)</option>
                    <option value="1000">å¾ˆæ…¢ (1s)</option>
                </select>
            </div>
            <div class="input-group">
                <label>éŒ¯èª¤ç‡</label>
                <select id="errorRate">
                    <option value="0">0% (ç¸½æ˜¯æ­£ç¢º)</option>
                    <option value="0.05">5%</option>
                    <option value="0.1" selected>10%</option>
                    <option value="0.15">15%</option>
                    <option value="0.2">20%</option>
                </select>
            </div>
            <button class="button primary" id="startBtn" onclick="startAutoTest()">é–‹å§‹è‡ªå‹•æ¸¬è©¦</button>
            <button class="button danger" id="stopBtn" onclick="stopAutoTest()" disabled>åœæ­¢æ¸¬è©¦</button>
            <button class="button" onclick="resetTest()">é‡ç½®</button>
            <button class="button" onclick="quickTest()">å¿«é€Ÿæ¸¬è©¦(1000æ¬¡)</button>
            <button class="button" onclick="calculateTheory()">ç†è«–è¨ˆç®—</button>
        </div>

        <div id="theoryResult"
            style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
            <h4>ğŸ“Š ç†è«–åˆ†æ</h4>
            <div id="theoryContent"></div>
        </div>

        <div class="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="practiceCount">0</div>
                <div class="stat-label">ç·´ç¿’æ¬¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">å®Œæˆç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">æ­£ç¢ºç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="timeElapsed">0s</div>
                <div class="stat-label">å·²ç”¨æ™‚é–“</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="estimatedTime">--</div>
                <div class="stat-label">é ä¼°å‰©é¤˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentStage">æº–å‚™ä¸­</div>
                <div class="stat-label">ç•¶å‰éšæ®µ</div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>ç®—æ³•çµ±è¨ˆ</h3>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="masteredCount">0</div>
                    <div class="stat-label">å·²æŒæ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="learningCount">0</div>
                    <div class="stat-label">å­¸ç¿’ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="difficultCount">0</div>
                    <div class="stat-label">å›°é›£é …</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="newCount">0</div>
                    <div class="stat-label">æœªé–‹å§‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="efficiency">--</div>
                    <div class="stat-label">ç·´ç¿’æ•ˆç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgReviews">--</div>
                    <div class="stat-label">å¹³å‡å¾©ç¿’æ¬¡æ•¸</div>
                </div>
            </div>
        </div>

        <div>
            <h3>æ¸¬è©¦æ—¥èªŒ</h3>
            <div class="log" id="testLog"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬ AdvancedSchedule é¡
        class AdvancedSchedule {
            constructor(name) {
                this.items = new Map();
                this.storageKey = `auto_test_${name}`;
                this.practiceCount = 0;

                // ç®—æ³•åƒæ•¸ - å¹³è¡¡å­¸ç¿’æ•ˆç‡èˆ‡è¨˜æ†¶éå›º
                this.NEW_CARD_RATIO = 0.30;
                this.INITIAL_INTERVALS = [3, 8, 20]; // é©ä¸­é–“éš”ï¼Œç¢ºä¿è¨˜æ†¶éå›º
                this.GRADUATION_THRESHOLD = 3; // æ¢å¾©åˆ°3æ¬¡é€£çºŒæ­£ç¢ºï¼Œç¬¦åˆå­¸ç¿’åŸç†
                this.EASY_MULTIPLIER = 2.0;
                this.GOOD_MULTIPLIER = 1.8; // é©ä¸­çš„ä¹˜æ•¸ï¼Œä¸æœƒå¢é•·éå¿«
                this.HARD_MULTIPLIER = 1.2;

                this.loadFromStorage();
            }

            loadFromStorage() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.items = new Map(parsed.items || []);
                        this.practiceCount = parsed.practiceCount || 0;
                    }
                } catch (e) {
                    console.warn('Failed to load from storage:', e);
                }
            }

            saveToStorage() {
                try {
                    const data = {
                        items: Array.from(this.items.entries()),
                        practiceCount: this.practiceCount
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                } catch (e) {
                    console.warn('Failed to save to storage:', e);
                }
            }

            recordSuccess(id) {
                const item = this.getOrCreateItem(id);
                this.practiceCount++;

                item.consecutiveCorrect++;
                item.totalReviews++;
                item.lastPracticed = this.practiceCount;
                item.isNew = false;

                // ç°¡åŒ–çš„é–“éš”è¨ˆç®— - èˆ‡çœŸå¯¦ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
                if (item.consecutiveCorrect <= this.INITIAL_INTERVALS.length) {
                    const intervalIndex = item.consecutiveCorrect - 1;
                    item.currentInterval = this.INITIAL_INTERVALS[intervalIndex] || this.INITIAL_INTERVALS[this.INITIAL_INTERVALS.length - 1];
                } else {
                    item.currentInterval = Math.floor(item.currentInterval * this.GOOD_MULTIPLIER);
                    item.currentInterval = Math.min(item.currentInterval, 50);
                }

                item.nextReviewAt = this.practiceCount + item.currentInterval;
                this.items.set(id, item);
                this.saveToStorage();
            }

            recordFailure(id) {
                const item = this.getOrCreateItem(id);
                this.practiceCount++;

                item.consecutiveCorrect = 0;
                item.totalReviews++;
                item.errorCount++;
                item.lastPracticed = this.practiceCount;
                item.isNew = false;

                // éŒ¯èª¤è™•ç†ï¼šç°¡åŒ–ç‚ºç«‹å³å¾©ç¿’ - èˆ‡çœŸå¯¦ç‰ˆæœ¬ä¸€è‡´
                item.currentInterval = 1;
                item.nextReviewAt = this.practiceCount + item.currentInterval;
                this.items.set(id, item);
                this.saveToStorage();
            }

            getOrCreateItem(id) {
                const existing = this.items.get(id);
                if (existing) {
                    return existing;
                }

                const newItem = {
                    id,
                    nextReviewAt: this.practiceCount + 1, // æ–°é …ç›®åœ¨ä¸‹ä¸€çµ„ç·´ç¿’
                    consecutiveCorrect: 0,
                    totalReviews: 0,
                    errorCount: 0,
                    lastPracticed: 0,
                    isNew: true,
                    currentInterval: 1
                };

                this.items.set(id, newItem);
                return newItem;
            }

            getNext(cardGroups) {
                // åˆ†é¡æ‰€æœ‰é …ç›® - èˆ‡çœŸå¯¦ç‰ˆæœ¬ä¸€è‡´
                const newItems = [];
                const dueReviews = [];

                for (const cardItem of cardGroups) {
                    const reviewItem = this.items.get(cardItem.code);

                    if (!reviewItem) {
                        // å®Œå…¨æ–°çš„é …ç›®
                        newItems.push(cardItem);
                    } else if (this.practiceCount >= reviewItem.nextReviewAt && reviewItem.consecutiveCorrect < this.GRADUATION_THRESHOLD) {
                        // åˆ°æœŸä¸”æœªæŒæ¡çš„é …ç›®
                        dueReviews.push(cardItem);
                    }
                }

                // å„ªå…ˆè™•ç†åˆ°æœŸå¾©ç¿’
                if (dueReviews.length > 0) {
                    return dueReviews[0];
                }

                // ç„¶å¾Œå­¸ç¿’æ–°å…§å®¹
                if (newItems.length > 0) {
                    return newItems[0];
                }

                return null;
            }

            getStats() {
                let mastered = 0;
                let learning = 0;
                let difficult = 0;

                for (const item of this.items.values()) {
                    if (item.consecutiveCorrect >= this.GRADUATION_THRESHOLD) {
                        mastered++;
                    } else if (item.errorCount >= 3) {
                        difficult++;
                    } else {
                        learning++;
                    }
                }

                return {
                    total: this.items.size,  // å·²ç·´ç¿’çš„é …ç›®æ•¸
                    mastered,
                    learning,
                    difficult
                };
            }

            reset() {
                this.items.clear();
                this.practiceCount = 0;
                localStorage.removeItem(this.storageKey);
            }
        }

        // æ¨¡æ“¬å­—æ ¹çµ„æ•¸æ“šï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
        const mockCardGroups = [];
        for (let i = 1; i <= 250; i++) {
            mockCardGroups.push({
                code: `zigen_${i}`,
                name: `å­—æ ¹${i}`,
                zigens: [{
                    font: `æ ¹${i}`,
                    ma: `z${i}`
                }]
            });
        }

        // æ¸¬è©¦è®Šé‡
        let schedule = new AdvancedSchedule('auto_test');
        let testInterval;
        let startTime;
        let totalPractices = 0;
        let successCount = 0;
        let isRunning = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats() {
            const stats = schedule.getStats();
            const now = Date.now();
            const elapsed = startTime ? Math.floor((now - startTime) / 1000) : 0;

            // è¨ˆç®—å®Œæˆç‡ï¼šå·²ç·´ç¿’é …ç›®æ•¸ / ç¸½ç›®æ¨™æ•¸
            const totalTargetItems = 250;
            const completionRate = stats.total / totalTargetItems;

            document.getElementById('practiceCount').textContent = totalPractices;
            document.getElementById('completionRate').textContent = `${Math.round(completionRate * 100)}%`;
            document.getElementById('successRate').textContent = totalPractices > 0 ? `${Math.round(successCount / totalPractices * 100)}%` : '0%';
            document.getElementById('timeElapsed').textContent = `${elapsed}s`;

            // æ›´æ–°é€²åº¦æ¢
            const progressFill = document.getElementById('progressFill');
            const progress = Math.round(completionRate * 100);
            progressFill.style.width = `${progress}%`;
            progressFill.textContent = `${progress}%`;

            // ä¼°ç®—å‰©é¤˜æ™‚é–“
            if (totalPractices > 0 && completionRate < 1) {
                const practicesPerSecond = totalPractices / elapsed;
                const targetPractices = parseInt(document.getElementById('targetPractices').value);
                const remainingPractices = targetPractices - totalPractices;
                const estimatedSeconds = Math.round(remainingPractices / practicesPerSecond);
                document.getElementById('estimatedTime').textContent = `${estimatedSeconds}s`;
            } else {
                document.getElementById('estimatedTime').textContent = '--';
            }

            // æ›´æ–°ç•¶å‰éšæ®µ
            if (completionRate >= 1) {
                document.getElementById('currentStage').textContent = 'å·²å®Œæˆ';
            } else if (completionRate >= 0.8) {
                document.getElementById('currentStage').textContent = 'è¡åˆºéšæ®µ';
            } else if (completionRate >= 0.5) {
                document.getElementById('currentStage').textContent = 'éå›ºéšæ®µ';
            } else if (completionRate >= 0.2) {
                document.getElementById('currentStage').textContent = 'å­¸ç¿’éšæ®µ';
            } else {
                document.getElementById('currentStage').textContent = 'èµ·æ­¥éšæ®µ';
            }

            // æ›´æ–°ç®—æ³•çµ±è¨ˆ
            const newCount = totalTargetItems - stats.total;
            document.getElementById('masteredCount').textContent = stats.mastered;
            document.getElementById('learningCount').textContent = stats.learning;
            document.getElementById('difficultCount').textContent = stats.difficult;
            document.getElementById('newCount').textContent = newCount;

            // è¨ˆç®—æ•ˆç‡å’Œå¹³å‡å¾©ç¿’æ¬¡æ•¸
            if (stats.total > 0) {
                const practicesPerItem = totalPractices / stats.total;
                document.getElementById('efficiency').textContent = `${practicesPerItem.toFixed(1)}x`;

                const allItems = Array.from(schedule.items.values());
                const totalReviews = allItems.reduce((sum, item) => sum + item.totalReviews, 0);
                const avgReviews = totalReviews / allItems.length;
                document.getElementById('avgReviews').textContent = avgReviews.toFixed(1);
            } else {
                document.getElementById('efficiency').textContent = '--';
                document.getElementById('avgReviews').textContent = '--';
            }
        }

        function practiceOnce() {
            const nextGroup = schedule.getNext(mockCardGroups);

            if (!nextGroup) {
                log('æ²’æœ‰æ›´å¤šé …ç›®éœ€è¦ç·´ç¿’ï¼', 'success');
                stopAutoTest();
                return;
            }

            totalPractices++;
            const errorRate = parseFloat(document.getElementById('errorRate').value);
            const isSuccess = Math.random() > errorRate;

            // è©³ç´°èª¿è©¦ä¿¡æ¯
            const stats = schedule.getStats();
            const completionRate = stats.total / 250;
            console.log(`ç·´ç¿’å‰ç‹€æ…‹: å·²ç·´ç¿’=${stats.total}, ç†Ÿç·´=${stats.mastered}, å®Œæˆç‡=${Math.round(completionRate * 100)}%`);

            if (isSuccess) {
                schedule.recordSuccess(nextGroup.code);
                successCount++;
                log(`ç·´ç¿’ ${nextGroup.name} - æ­£ç¢º (é€£çºŒæ­£ç¢º: ${schedule.items.get(nextGroup.code)?.consecutiveCorrect || 0})`, 'success');
            } else {
                schedule.recordFailure(nextGroup.code);
                log(`ç·´ç¿’ ${nextGroup.name} - éŒ¯èª¤`, 'failure');
            }

            updateStats();

            // æª¢æŸ¥æ˜¯å¦é”åˆ°ç›®æ¨™
            const targetPractices = parseInt(document.getElementById('targetPractices').value);
            const newStats = schedule.getStats();
            const newCompletionRate = newStats.total / 250;
            console.log(`ç·´ç¿’å¾Œç‹€æ…‹: å·²ç·´ç¿’=${newStats.total}, ç†Ÿç·´=${newStats.mastered}, å®Œæˆç‡=${Math.round(newCompletionRate * 100)}%`);

            if (totalPractices >= targetPractices) {
                const finalStats = schedule.getStats();
                const finalCompletionRate = finalStats.total / 250;
                log(`é”åˆ°ç›®æ¨™ç·´ç¿’æ¬¡æ•¸ ${targetPractices}ï¼Œå®Œæˆç‡ï¼š${Math.round(finalCompletionRate * 100)}%`, 'warning');

                // é¡¯ç¤ºè©³ç´°çµæœ
                const practicesPerItem = finalStats.total > 0 ? (totalPractices / finalStats.total).toFixed(1) : 'N/A';
                log(`ğŸ“Š æ¸¬è©¦çµæœ: å·²ç·´ç¿’${finalStats.total}/250é …, æŒæ¡${finalStats.mastered}é …, æ•ˆç‡${practicesPerItem}x`, 'info');

                if (finalCompletionRate >= 1) {
                    log('ğŸ‰ æ­å–œï¼æ‰€æœ‰é …ç›®éƒ½å·²é–‹å§‹ç·´ç¿’ï¼', 'success');
                } else if (finalCompletionRate >= 0.8) {
                    log('ğŸ‘ è¡¨ç¾è‰¯å¥½ï¼Œå¤§éƒ¨åˆ†é …ç›®å·²é–‹å§‹ç·´ç¿’', 'success');
                } else {
                    log('âš ï¸ å»ºè­°èª¿æ•´ç®—æ³•åƒæ•¸ä»¥æé«˜æ•ˆç‡', 'warning');
                }

                stopAutoTest();
            } else if (newCompletionRate >= 1) {
                log(`æ‰€æœ‰é …ç›®éƒ½å·²å®Œæˆï¼ç¸½ç·´ç¿’æ¬¡æ•¸ï¼š${totalPractices}`, 'success');
                stopAutoTest();
            }
        }

        function startAutoTest() {
            if (isRunning) return;

            isRunning = true;
            startTime = Date.now();
            const speed = parseInt(document.getElementById('speed').value);

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('stats').classList.add('running');

            log('é–‹å§‹è‡ªå‹•æ¸¬è©¦...', 'info');

            testInterval = setInterval(practiceOnce, speed);
        }

        function stopAutoTest() {
            if (!isRunning) return;

            isRunning = false;

            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('stats').classList.remove('running');

            const stats = schedule.getStats();
            const completionRate = stats.total / 250;
            log(`æ¸¬è©¦å·²åœæ­¢ã€‚å®Œæˆç‡ï¼š${Math.round(completionRate * 100)}%ï¼Œç¸½ç·´ç¿’ï¼š${totalPractices}æ¬¡`, 'info');
        }

        function quickTest() {
            if (isRunning) {
                log('è«‹å…ˆåœæ­¢ç•¶å‰æ¸¬è©¦', 'warning');
                return;
            }

            // è¨­ç½®å¿«é€Ÿæ¸¬è©¦åƒæ•¸
            document.getElementById('targetPractices').value = '1000';
            document.getElementById('speed').value = '10';
            document.getElementById('errorRate').value = '0.1';

            log('é–‹å§‹å¿«é€Ÿæ¸¬è©¦ (1000æ¬¡ç·´ç¿’ï¼Œ10%éŒ¯èª¤ç‡)...', 'info');
            startAutoTest();
        }

        function calculateTheory() {
            const errorRate = parseFloat(document.getElementById('errorRate').value);
            const intervals = [3, 8, 20]; // ç•¶å‰è¨­ç½®çš„é–“éš”
            const graduationThreshold = 3;
            const totalItems = 250;

            // ä¿®æ­£çš„ç†è«–è¨ˆç®—
            const successRate = 1 - errorRate;

            // è¨ˆç®—é”åˆ°Næ¬¡é€£çºŒæˆåŠŸçš„æœŸæœ›å˜—è©¦æ¬¡æ•¸
            // ä½¿ç”¨æ­£ç¢ºçš„å¹¾ä½•åˆ†å¸ƒå…¬å¼
            function expectedTrialsForConsecutiveSuccesses(n, p) {
                // éæ­¸å…¬å¼: E[T_n] = (1 + (1-p) * E[T_n]) / p + E[T_{n-1}]
                // ç°¡åŒ–ç‚º: E[T_n] = (1/p) * (1 + E[T_{n-1}])
                if (n === 1) return 1 / p;
                return (1 / p) * (1 + expectedTrialsForConsecutiveSuccesses(n - 1, p));
            }

            const expectedTriesToGraduate = expectedTrialsForConsecutiveSuccesses(graduationThreshold, successRate);

            // æ¯å€‹é …ç›®çš„é æœŸç·´ç¿’æ¬¡æ•¸å°±æ˜¯é”åˆ°ç•¢æ¥­æ‰€éœ€çš„æ¬¡æ•¸
            // ä¸éœ€è¦é¡å¤–çš„"é–“éš”æˆæœ¬"ï¼Œå› ç‚ºç®—æ³•æ˜¯ä¸¦è¡Œèª¿åº¦çš„
            const averagePracticesPerItem = expectedTriesToGraduate;

            const totalExpectedPractices = Math.round(totalItems * averagePracticesPerItem);
            const efficiency = averagePracticesPerItem.toFixed(1);

            // é¡¯ç¤ºçµæœ
            const resultDiv = document.getElementById('theoryResult');
            const contentDiv = document.getElementById('theoryContent');

            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><strong>éŒ¯èª¤ç‡:</strong> ${(errorRate * 100)}%</div>
                    <div><strong>æˆåŠŸç‡:</strong> ${(successRate * 100)}%</div>
                    <div><strong>ç•¢æ¥­é–€æª»:</strong> ${graduationThreshold}æ¬¡é€£çºŒæ­£ç¢º</div>
                    <div><strong>åˆå§‹é–“éš”:</strong> [${intervals.join(', ')}]</div>
                    <div><strong>é …ç›®ç¸½æ•¸:</strong> ${totalItems}</div>
                    <div><strong>é æœŸæ•ˆç‡:</strong> ${efficiency}x (æ¯é …ç›®å¹³å‡ç·´ç¿’æ¬¡æ•¸)</div>
                    <div><strong>é æœŸç¸½ç·´ç¿’:</strong> ${totalExpectedPractices}æ¬¡</div>
                    <div><strong>ç†è«–ç¯„åœ:</strong> ${Math.round(totalExpectedPractices * 0.9)} - ${Math.round(totalExpectedPractices * 1.1)}æ¬¡</div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                    <strong>ğŸ“ ç†è«–æ¨¡å‹:</strong>
                    ä½¿ç”¨å¹¾ä½•åˆ†å¸ƒè¨ˆç®—é€£çºŒæˆåŠŸçš„æœŸæœ›æ¬¡æ•¸ï¼Œ${graduationThreshold}æ¬¡é€£çºŒæˆåŠŸ(${(successRate * 100)}%æˆåŠŸç‡)çš„æœŸæœ›å˜—è©¦æ¬¡æ•¸ç‚º ${expectedTriesToGraduate.toFixed(1)}
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <strong>ï¿½ è©•ä¼°:</strong>
                    ${efficiency < 3 ? 'âš ï¸ å¯èƒ½éæ–¼å®¹æ˜“ï¼Œè¨˜æ†¶éå›ºä¸è¶³' :
                    efficiency > 6 ? 'âš ï¸ å¯èƒ½éæ–¼å›°é›£ï¼Œå­¸ç¿’æ•ˆç‡åä½' :
                        'âœ… åƒæ•¸è¨­ç½®åˆç†ï¼Œå¹³è¡¡æ•ˆç‡èˆ‡è¨˜æ†¶éå›º'}
                </div>
            `;

            resultDiv.style.display = 'block';
            log(`ä¿®æ­£ç†è«–è¨ˆç®—ï¼šé æœŸéœ€è¦ ${totalExpectedPractices} æ¬¡ç·´ç¿’ (${efficiency}xæ•ˆç‡)`, 'info');
        } function resetTest() {
            stopAutoTest();
            schedule.reset();
            totalPractices = 0;
            successCount = 0;
            startTime = null;

            document.getElementById('testLog').innerHTML = '';
            updateStats();

            log('æ¸¬è©¦å·²é‡ç½®', 'info');
        }

        // åˆå§‹åŒ–
        updateStats();
        log('è‡ªå‹•æ¸¬è©¦å·¥å…·å·²æº–å‚™å°±ç·’', 'info');
    </script>
</body>

</html>