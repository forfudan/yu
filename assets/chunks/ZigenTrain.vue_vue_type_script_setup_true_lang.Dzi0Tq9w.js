var ne=Object.defineProperty;var se=(C,t,e)=>t in C?ne(C,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):C[t]=e;var k=(C,t,e)=>se(C,typeof t!="symbol"?t+"":t,e);import{b as ae,f as le}from"./share.DVhxay46.js";import{d as te,h as I,l as Z,R as U,aa as X,k as F,v as ie,c as m,o as p,F as ee,e as z,m as s,t as T,O as ce,n as E,p as $,C as ue,a3 as de,a4 as ge,a as K,a0 as ve,a2 as fe,_ as me,E as W,H as pe}from"./framework.2ez64Ajs.js";import{f as he}from"./share.B37RtnLc.js";class re{constructor(t){k(this,"items",new Map);k(this,"storageKey");k(this,"practiceCount",0);k(this,"NEW_CARD_RATIO",.3);k(this,"INITIAL_INTERVALS",[16,64,256]);k(this,"GRADUATION_THRESHOLD",3);k(this,"EASY_MULTIPLIER",3);k(this,"GOOD_MULTIPLIER",2.5);k(this,"HARD_MULTIPLIER",1.5);this.storageKey=`spaced_repetition_${t}`,this.loadFromStorage()}recordSuccess(t){const e=this.getOrCreateItem(t);if(this.practiceCount++,e.consecutiveCorrect++,e.totalReviews++,e.lastPracticed=this.practiceCount,e.isNew=!1,e.consecutiveCorrect<=this.INITIAL_INTERVALS.length){const r=e.consecutiveCorrect-1;e.currentInterval=this.INITIAL_INTERVALS[r]||this.INITIAL_INTERVALS[this.INITIAL_INTERVALS.length-1]}else e.consecutiveCorrect>=this.GRADUATION_THRESHOLD?(e.currentInterval=Math.floor(e.currentInterval*this.GOOD_MULTIPLIER),e.currentInterval=Math.min(e.currentInterval,100)):e.currentInterval=Math.floor(e.currentInterval*this.HARD_MULTIPLIER);e.nextReviewAt=this.practiceCount+e.currentInterval,this.items.set(t,e),this.saveToStorage(),console.log(`成功記錄 ${t}: 連續正確=${e.consecutiveCorrect}, 當前間隔=${e.currentInterval}, 下次復習位置=${e.nextReviewAt}`)}recordFailure(t){const e=this.getOrCreateItem(t);this.practiceCount++,e.consecutiveCorrect=0,e.totalReviews++,e.errorCount++,e.lastPracticed=this.practiceCount,e.isNew=!1,e.errorCount===1?e.currentInterval=1:(e.errorCount<=3,e.currentInterval=0),e.nextReviewAt=this.practiceCount+e.currentInterval,this.items.set(t,e),this.saveToStorage(),console.log(`錯誤記錄 ${t}: 錯誤次數=${e.errorCount}, 當前間隔=${e.currentInterval}, 下次復習位置=${e.nextReviewAt}`)}getNext(t){const e=[],r=[],h=[];for(const c of t){const g=this.items.get(c.code);if(!g)e.push(c);else if(this.practiceCount>=g.nextReviewAt){let f=this.calculatePriority(g);r.push({item:c,priority:f,reviewItem:g})}else g.consecutiveCorrect<this.GRADUATION_THRESHOLD&&h.push(c)}if(r.length>0)return r.sort((c,g)=>g.priority-c.priority),console.log(`選擇復習項目: ${r[0].item.code} (優先級: ${r[0].priority})`),r[0].item;const v=this.items.size;if(e.length>0&&(v===0||e.length/(e.length+v)>=this.NEW_CARD_RATIO))return console.log(`選擇新項目: ${e[0].code}`),e[0];if(h.length>0){const c=h.map(f=>({item:f,reviewItem:this.items.get(f.code)})).filter(({reviewItem:f})=>f.errorCount>0).sort((f,w)=>w.reviewItem.errorCount-f.reviewItem.errorCount);if(c.length>0)return console.log(`選擇困難學習項目: ${c[0].item.code}`),c[0].item;const g=h[Math.floor(Math.random()*h.length)];return console.log(`選擇隨機學習項目: ${g.code}`),g}return e.length>0?(console.log(`選擇剩餘新項目: ${e[0].code}`),e[0]):(console.log("沒有更多項目需要練習"),null)}calculatePriority(t){let e=1e3;e+=t.errorCount*500;const r=this.practiceCount-t.nextReviewAt;return e+=Math.max(0,r)*100,t.consecutiveCorrect===0&&(e+=200),e}getStats(){let t=0,e=0,r=0;for(const h of this.items.values())h.consecutiveCorrect>=3&&h.errorCount<=1?t++:h.errorCount>=3?r++:e++;return{total:this.items.size,mastered:t,learning:e,difficult:r}}getItemStats(t){return this.items.get(t)||null}isFirstTime(t){const e=this.items.get(t);return!e||e.isNew||e.totalReviews===0}getCurrentProgress(){const t=this.items.size,r=Math.max(t*4,this.practiceCount+50);return{practiceCount:this.practiceCount,estimatedTotal:r}}getOrCreateItem(t){const e=this.items.get(t);return e||{id:t,nextReviewAt:this.practiceCount+1,consecutiveCorrect:0,totalReviews:0,errorCount:0,lastPracticed:0,isNew:!0,currentInterval:1}}loadFromStorage(){try{const t=localStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);this.items=new Map(Object.entries(e.items||{})),this.practiceCount=e.practiceCount||0}}catch(t){console.warn("載入調度數據失敗:",t)}}saveToStorage(){try{const t={items:Object.fromEntries(this.items),practiceCount:this.practiceCount};localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(t){console.warn("保存調度數據失敗:",t)}}reset(){this.items.clear(),this.practiceCount=0,localStorage.removeItem(this.storageKey)}getProgress(){const t=this.items.size,r=Math.max(t*4,this.practiceCount+50);return{practiceCount:this.practiceCount,estimatedTotal:r}}}const xe={key:0,class:"max-w-2xl mx-auto p-6 space-y-6"},ye={class:"relative"},we={class:"text-center text-sm text-gray-600 dark:text-gray-400"},be={class:"flex justify-between items-center mb-2"},Ce={key:0,class:"text-red-600 dark:text-red-400"},ke={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2"},Ie={class:"absolute top-4 right-4 flex gap-2 z-10"},_e=["title"],Se={class:"text-center py-12"},Re={key:0,class:"text-sm text-gray-600 dark:text-gray-300 font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded"},Te={class:"flex justify-center pb-8"},Le={class:"inline-block bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-lg"},Ae={class:"font-mono text-xl font-bold text-blue-600 dark:text-blue-400"},Me={class:"text-center text-sm text-gray-500 dark:text-gray-400 space-y-1"},Ne={key:0,class:"flex items-center justify-center gap-4"},Oe={key:1,class:"text-blue-600 dark:text-blue-400 font-medium"},ze=te({__name:"TrainCardGroup",props:{name:{},cardGroups:{},chaifenMap:{},mode:{},supplement:{type:Boolean},ming:{type:Boolean},isFrequencyOrder:{type:Boolean},onToggleSort:{type:Function},onReset:{type:Function}},setup(C){const t=C,{name:e,cardGroups:r,mode:h,supplement:v,ming:L,isFrequencyOrder:c,onToggleSort:g,onReset:f}=t;console.log(`載入分組練習會話: ${e}`);const w=new re(e),G=I(0),A=I(),S=I(""),x=I(!1),b=I(!0),P=I(0),R=I(!1),D=I(0),H=()=>{R.value=!0},a=()=>{f&&(f(),R.value=!1,setTimeout(()=>{window.location.reload()},100))},l=()=>{R.value=!1},i=I(typeof window<"u"?window.innerWidth:1024),M=()=>{i.value=window.innerWidth};Z(()=>{typeof window<"u"&&window.addEventListener("resize",M),U(()=>{var n;(n=A.value)==null||n.focus()}),document.addEventListener("keydown",V),q()}),X(()=>{typeof window<"u"&&window.removeEventListener("resize",M),document.removeEventListener("keydown",V)});const _=F(()=>{if(!d.value)return"text-8xl";const n=d.value.zigens.length,o=i.value<768,u=i.value<1024;return o?n<=2?"text-6xl":n<=4?"text-5xl":"text-4xl":u?n<=2?"text-8xl":n<=4?"text-7xl":"text-6xl":n<=2?"text-9xl":n<=4?"text-8xl":"text-7xl"}),j=F(()=>{if(!d.value)return"gap-8 lg:gap-12";const n=d.value.zigens.length;return i.value<768?n>4?"gap-3":"gap-4":n>4?"gap-6":"gap-8 lg:gap-12"}),d=F(()=>r[G.value]||null);F(()=>r.length);const N=F(()=>{D.value;const o=w.getStats().total,u=r.length;return{current:o,total:u,percentage:u>0?(o/u*100).toFixed(1):"0"}}),J=F(()=>N.value.percentage);ie(S,n=>{if(!d.value)return;const o=n.trim().toLowerCase(),u=d.value.code.toLowerCase();o.length>=u.length&&(o===u?oe():x.value||Y())});const oe=()=>{d.value&&(b.value=!0,w.recordSuccess(d.value.code),D.value++,q())},Y=()=>{d.value&&(b.value=!1,P.value++,x.value=!0,w.recordFailure(d.value.code),D.value++,S.value="",U(()=>{var n;(n=A.value)==null||n.focus()}))},q=()=>{var u;const n=w.getNext(r);if(n)G.value=r.findIndex(y=>y.code===n.code);else{const y=r.filter(O=>{const B=w.getItemStats(O.code);return!B||B.consecutiveCorrect<3||B.errorCount>0});if(y.length>0){const O=y[Math.floor(Math.random()*y.length)];G.value=r.findIndex(B=>B.code===O.code)}else G.value=Math.floor(Math.random()*r.length)}b.value=!0,P.value=0,S.value="";const o=(u=d.value)==null?void 0:u.code;o&&w.isFirstTime(o)?(x.value=!0,console.log(`字根組 "${o}" 第一次出現，直接顯示答案`)):x.value=!1,U(()=>{var y;(y=A.value)==null||y.focus()})},V=n=>{n.key==="Escape"&&!x.value&&(Y(),n.preventDefault())},Q=n=>{const o=he(n,t.chaifenMap),u=i.value<768,y=i.value<1024;let O=4;return u?O=2:y&&(O=3),o.slice(0,O).split("").join("")};return Z(()=>{U(()=>{var n;(n=A.value)==null||n.focus()}),document.addEventListener("keydown",V),q()}),X(()=>{document.removeEventListener("keydown",V)}),(n,o)=>(p(),m(ee,null,[d.value?(p(),m("div",xe,[s("div",ye,[s("div",we,[s("div",be,[s("span",null,"已練習字根組: "+T(N.value.current)+" / "+T(N.value.total)+" (進度 "+T(N.value.percentage)+"%)",1),P.value>0?(p(),m("span",Ce,"錯誤次數: "+T(P.value),1)):z("",!0)]),s("div",ke,[s("div",{class:"bg-blue-500 dark:bg-blue-400 h-2 rounded-full transition-all duration-300",style:ce(`width: ${J.value}%`)},null,4)])])]),s("div",{class:E(["w-full shadow-lg rounded-2xl transition-all duration-300 transform relative",{"bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800":!b.value,"bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800":b.value},"border-2 hover:shadow-xl"])},[s("div",Ie,[$(g)?(p(),m("button",{key:0,onClick:o[0]||(o[0]=()=>{console.log("排序按鈕被點擊，當前狀態:",$(c)),$(g)()}),class:E(["w-8 h-8 rounded-full font-medium transition-all duration-200 flex items-center justify-center text-xs shadow-md",$(c)?"bg-orange-500 hover:bg-orange-600 text-white":"bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200"]),title:$(c)?"字頻序 (點擊切換到字典序)":"字典序 (點擊切換到字頻序)"},[...o[3]||(o[3]=[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})],-1)])],10,_e)):z("",!0),$(f)?(p(),m("button",{key:1,onClick:H,class:"w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 text-white font-medium transition-all duration-200 flex items-center justify-center text-xs shadow-md",title:"重新開始訓練"},[...o[4]||(o[4]=[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)])])):z("",!0)]),s("div",Se,[s("div",{class:E(["flex justify-center items-center flex-wrap mb-12",j.value])},[(p(!0),m(ee,null,ue(d.value.zigens,(u,y)=>(p(),m("div",{key:y,class:"flex flex-col items-center group"},[s("div",{class:E(["mb-4 zigen-font transform transition-all duration-300 group-hover:scale-110",_.value,{"text-red-500 dark:text-red-400":!b.value,"text-blue-700 dark:text-blue-300":b.value}])},T(u.font),3),x.value?(p(),m("div",Re,T(u.ma),1)):z("",!0),Q(u.font)?(p(),m("div",{key:1,class:E(["text-gray-600 dark:text-gray-300 mt-2 font-medium tracking-tight zigen-font",{"text-sm":i.value<768,"text-base":i.value>=768&&i.value<1024,"text-lg":i.value>=1024}])},T(Q(u.font)),3)):z("",!0)]))),128))],2)]),s("div",Te,[de(s("input",{ref_key:"inputElement",ref:A,"onUpdate:modelValue":o[1]||(o[1]=u=>S.value=u),type:"text",placeholder:"編碼",class:E(["px-6 py-4 text-2xl text-center border-2 rounded-xl w-48 font-mono","transition-all duration-300 focus:outline-none focus:ring-4",{"border-red-300 focus:border-red-500 focus:ring-red-200 bg-red-50 dark:border-red-700 dark:focus:border-red-500 dark:focus:ring-red-900/50 dark:bg-red-900/20 dark:text-white":!b.value,"border-blue-300 focus:border-blue-500 focus:ring-blue-200 bg-white dark:border-blue-700 dark:focus:border-blue-500 dark:focus:ring-blue-900/50 dark:bg-gray-800 dark:text-white":b.value}])},null,2),[[ge,S.value]])]),s("div",{class:E(["text-center pb-8 transition-all duration-300",{"opacity-0 transform translate-y-2":!x.value,"opacity-100":x.value}])},[s("div",Le,[o[5]||(o[5]=s("span",{class:"text-gray-800 dark:text-gray-200"},"答案是",-1)),o[6]||(o[6]=K()),s("span",Ae,T(d.value.code),1)])],2)],2),s("div",Me,[x.value?(p(),m("div",Oe," 繼續輸入正確編碼 ")):(p(),m("div",Ne,[...o[7]||(o[7]=[s("span",{class:"flex items-center gap-1"},[s("kbd",{class:"px-2 py-1 text-xs bg-gray-100 dark:bg-gray-800 dark:text-gray-300 rounded"},"輸入"),K(" 自動檢查 ")],-1),s("span",{class:"flex items-center gap-1"},[s("kbd",{class:"px-2 py-1 text-xs bg-gray-100 dark:bg-gray-800 dark:text-gray-300 rounded"},"Esc"),K(" 顯示答案 ")],-1)])]))])])):z("",!0),R.value?(p(),m("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:l},[s("div",{class:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm mx-4 shadow-xl",onClick:o[2]||(o[2]=ve(()=>{},["stop"]))},[o[8]||(o[8]=fe('<div class="flex items-center gap-3 mb-4" data-v-54179336><div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center" data-v-54179336><svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-54179336><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" data-v-54179336></path></svg></div><div data-v-54179336><h3 class="text-lg font-medium text-gray-900 dark:text-gray-100" data-v-54179336>確認重置</h3><p class="text-sm text-gray-600 dark:text-gray-400" data-v-54179336>您確定要重新開始訓練嗎？</p></div></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-6" data-v-54179336> 這將清除當前的學習進度和統計數據，無法恢復。 </p>',2)),s("div",{class:"flex gap-3 justify-end"},[s("button",{onClick:l,class:"px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"}," 取消 "),s("button",{onClick:a,class:"px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors"}," 確認重置 ")])])])):z("",!0)],64))}}),Ee=me(ze,[["__scopeId","data-v-54179336"]]),$e={key:0},Ge={key:1,class:"text-gray-700 dark:text-gray-300 text-center"},Be=te({__name:"ZigenTrain",props:{name:{},zigenUrl:{},range:{},mode:{},supplement:{type:Boolean},ming:{type:Boolean}},setup(C){const t=C;let e=t.name+"_zigen_grouped";const r=t.range;r&&(e+=`_${r[0]}_${r[1]}`);const h=`zigen_sort_order_${t.name}`,v=I(!1),L=W(),c=W(),g=W();function f(){try{const a=localStorage.getItem(h);if(a!==null){const l=JSON.parse(a);v.value=l,console.log("載入保存的排序狀態:",l)}}catch(a){console.warn("載入排序狀態失敗:",a)}}function w(){try{localStorage.setItem(h,JSON.stringify(v.value)),console.log("排序狀態已保存:",v.value)}catch(a){console.warn("保存排序狀態失敗:",a)}}const G=["口","一","月","丶","日","人","亻","扌","白","土","丷","二","又","丿","宀","木","尚","辶","小","冖","厶","心","氵","八","女","大","艹","𠂇","匕","寸","也","乙","戈","目","讠","不","龰","阝","竹","了","十","夂","王","刂","儿","力","凵","冂","子","斤","火","米","丁","彐","纟","文","立","士","夕","乂","门","卜","自","尤","彳","羊","止","禾","贝","尸","工","乚","上","囗","至","手","𬺰","艮","车","石","田","己","几","牛","见","走","甲","且","彡","犬","巾","西","方","刀","殳","七","弓","巴","矢","示"],A=["鳥","烏","魚","馬","風","來","車","長","門","鬥","齒","飛","見","貝","鹵","僉","韋","咼","黽"],S=a=>{switch(t.mode){case"A":return a[0];case"a":return a[1];case"both":return a}};function x(a){for(const l of a.zigens){const i=G.indexOf(l.font);if(i!==-1)return i}for(const l of a.zigens){const i=A.indexOf(l.font);if(i!==-1)return 1e4+i}return 5e3}function b(a){return[...a].sort((l,i)=>{const M=x(l),_=x(i);return M-_})}function P(){console.log("切換排序模式被調用，當前狀態:",v.value),v.value=!v.value,console.log("切換後狀態:",v.value),w(),R(),console.log("排序應用完成，按鈕應該顯示為:",v.value?"橙色（字頻序）":"灰色（字典序）"),setTimeout(()=>{window.location.reload()},100)}function R(){L.value?(v.value?(c.value=b(L.value),console.log("已切換到字頻序，重新排序了",c.value.length,"個字根組")):(c.value=[...L.value],console.log("已切換到字典序，恢復原始順序")),U(()=>{console.log("排序更新完成，當前順序:",c.value.slice(0,3).map(a=>a.code))})):console.warn("originalCardGroups 未初始化，無法應用排序")}function D(a){var i,M;const l=[];for(let _=0;_<a.length;_++){const j=a[_],d=(i=S(j.ma))==null?void 0:i.toLowerCase();if(!d)continue;const N=_>0?a[_-1]:null;(N?(M=S(N.ma))==null?void 0:M.toLowerCase():null)===d&&l.length>0&&l[l.length-1].code===d?l[l.length-1].zigens.push(j):l.push({code:d,zigens:[j]})}return l}function H(){L.value&&(new re(e).reset(),v.value=!1,w(),R(),console.log("訓練已重置，排序狀態重置為字典序"))}return Z(async()=>{f(),g.value=await ae("/chaifen.csv");let l=[...(await le(t.zigenUrl)).values()];r&&(l=l.slice(r[0],r[1]));const i=D(l);L.value=i,R(),console.log(`字根練習：共 ${i.length} 個編碼組，包含 ${l.length} 個字根，當前${v.value?"字頻序":"字典序"}`)}),(a,l)=>c.value&&g.value?(p(),m("div",$e,[pe(Ee,{name:$(e),"card-groups":c.value,"chaifen-map":g.value,mode:"g",supplement:t.supplement??!1,ming:t.ming??!1,"is-frequency-order":v.value,"on-toggle-sort":P,"on-reset":H},null,8,["name","card-groups","chaifen-map","supplement","ming","is-frequency-order"])])):(p(),m("h2",Ge," 下載資料中…… "))}});export{Be as _};
