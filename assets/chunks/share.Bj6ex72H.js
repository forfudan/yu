var F=Object.defineProperty;var Z=(r,t,s)=>t in r?F(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var g=(r,t,s)=>Z(r,typeof t!="symbol"?t+"":t,s);import{g as J}from"./framework.D3o4Ln5n.js";const u=class u{constructor(t){g(this,"data",null);g(this,"loading",null);g(this,"dataUrl");g(this,"pakoLoaded",!1);this.dataUrl=t}async loadPako(){if(window.pako||this.pakoLoaded)return window.pako;try{const t=document.createElement("script");return t.src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js",t.crossOrigin="anonymous",await new Promise((s,n)=>{t.onload=s,t.onerror=n,document.head.appendChild(t)}),this.pakoLoaded=!0,window.pako}catch(t){return console.warn("Failed to load pako library:",t),null}}static getInstance(t="/chaifen.json"){return u.instances.has(t)||u.instances.set(t,new u(t)),u.instances.get(t)}async loadData(){return this.data?this.data:this.loading?this.loading:(this.loading=this.fetchOptimizedData(),this.data=await this.loading,this.loading=null,this.data)}async fetchOptimizedData(){const t=performance.now(),n=[{url:this.dataUrl.replace(".csv",".json"),compressed:!0},{url:this.dataUrl,compressed:!1,csv:!0}];for(const a of n)try{const e=await fetch(a.url,{headers:{Accept:"application/json, text/csv, */*","Accept-Charset":"utf-8"}});if(!e.ok)continue;let o;if(a.csv){const h=await e.arrayBuffer(),c=new TextDecoder("utf-8").decode(h);o=this.parseCsvToOptimized(c)}else if(a.compressed){const h=await e.arrayBuffer(),c=await this.decompressGzip(h),l=new TextDecoder("utf-8").decode(c);o=JSON.parse(l)}else{const h=await e.arrayBuffer(),c=new TextDecoder("utf-8").decode(h);o=JSON.parse(c)}const i=performance.now()-t;return console.log(`📊 Loaded ${a.url} in ${i.toFixed(2)}ms`),console.log(`📦 Data contains ${Object.keys(o).length} characters`),o}catch(e){console.warn(`Failed to load ${a.url}:`,e);continue}throw new Error("Failed to load chaifen data from any source")}parseCsvToOptimized(t){const s=t.split(`
`),n={};for(let a=1;a<s.length;a++){const e=s[a].trim();if(!e)continue;const[o,i,h,c]=e.split(",");if(o){const l={};i&&(l.d=i),h&&(l.dt=h),c&&(l.r=c),n[o]=l}}return n}search(t){var a,e;if(!this.data)return console.warn("Data not loaded yet"),[];const s=[],n=t.toLowerCase();if(t.length===1&&this.data[t]){const o=this.data[t];s.push({char:t,division:o.d,division_tw:o.dt,region:o.r})}for(const[o,i]of Object.entries(this.data))(o.includes(n)||(a=i.d)!=null&&a.toLowerCase().includes(n)||(e=i.dt)!=null&&e.toLowerCase().includes(n))&&s.push({char:o,division:i.d,division_tw:i.dt,region:i.r});return s}getChar(t){if(!this.data||!this.data[t])return null;const s=this.data[t];return{char:t,division:s.d,division_tw:s.dt,region:s.r}}async decompressGzip(t){try{const s=await this.loadPako();if(s){console.log("📦 Using pako for gzip decompression");const l=new Uint8Array(t);return s.inflate(l).buffer}if(console.log("🌐 Using browser DecompressionStream for gzip decompression"),typeof DecompressionStream>"u")throw new Error("DecompressionStream not supported and pako not available");const a=new ReadableStream({start(l){l.enqueue(new Uint8Array(t)),l.close()}}).pipeThrough(new DecompressionStream("gzip")),e=[],o=a.getReader();for(;;){const{done:l,value:p}=await o.read();if(l)break;e.push(p)}const i=e.reduce((l,p)=>l+p.length,0),h=new Uint8Array(i);let c=0;for(const l of e)h.set(l,c),c+=l.length;return h.buffer}catch(s){throw console.error("Failed to decompress gzip data:",s),new Error(`Gzip decompression failed: ${s.message}`)}}};g(u,"instances",new Map);let k=u,m={};function I(r,t,s,n,a){var o,i,h,c,l,p,D,S,j,L,O,$,b,x,U,T,z,A;const e=[...r];if(n){let d=[];const f=e[0],y=e[e.length-1];e.length==1?d.push((((i=(o=t.get(f))==null?void 0:o.ma)==null?void 0:i[0])||"?").toUpperCase()):d.push((((c=(h=t.get(f))==null?void 0:h.ma)==null?void 0:c.slice(0,-1))||"?").toUpperCase()),d.push(...e.slice(1).map(w=>{var B,E;return(((E=(B=t.get(w))==null?void 0:B.ma)==null?void 0:E[0])||"?").toUpperCase()}));const v=w=>w.length===2?w[0].toUpperCase()+w[1]:w;return d.push(v(((p=(l=t.get(y))==null?void 0:l.ma)==null?void 0:p.slice(1))||"?")),d.join("").slice(0,5)}else if(a){let d=[];if(e.length>=1&&d.push(((S=(D=t.get(e[0]))==null?void 0:D.ma)==null?void 0:S[0])||"?"),e.length>=2&&d.push(((L=(j=t.get(e[1]))==null?void 0:j.ma)==null?void 0:L[0])||"?"),e.length>=3){const f=e[e.length-1];d.push((($=(O=t.get(f))==null?void 0:O.ma)==null?void 0:$[0])||"?")}if(d.length<3){const f=e[e.length-1];d.push(((x=(b=t.get(f))==null?void 0:b.ma)==null?void 0:x[1])||"?")}return d.join("")}else{let d=e.map(f=>{var y,v;return((v=(y=t.get(f))==null?void 0:y.ma)==null?void 0:v[0])||"?"});if(d.length<4){const f=e[e.length-1];d.push(((T=(U=t.get(f))==null?void 0:U.ma)==null?void 0:T[1])||"?")}if(d.length<4&&s){const f=e[0];d.push(((A=(z=t.get(f))==null?void 0:z.ma)==null?void 0:A[1])||"?")}return d.join("")}}async function C(r){if(r in m)return m[r];try{const s=await(await fetch(J(r))).text(),n=N(s);return m[r]=n,n}catch(t){throw t instanceof Error&&alert(`無法下載或解析《${r}》文件：${t.cause}`),t}}function N(r){const t=r.split(`
`),n=t.shift().split(",").map(o=>o.trim()),a=n.length,e=new Map;for(let o of t){if(o=o.trim(),!o)continue;const i=o.split(",").map(c=>c.trim());if(i.length<a)for(;i.length<a;)i.push("");else if(i.length>a)throw new Error(`CSV文件中 ${o} 數據過多，期望 ${a} 列，实际 ${i.length} 列。`);const h={};for(let c=0;c<a;c++)h[n[c]]=i[c]||"";e.set(i[0],h)}return e}async function P(r){return await C(r)}async function R(r){return await C(r)}async function K(r){const t=`optimized_${r}`;if(t in m)return m[t];try{const n=await k.getInstance(r).loadData(),a=new Map;for(const[e,o]of Object.entries(n))a.set(e,{char:e,division:o.d||"",division_tw:o.dt||"",region:o.r||""});return console.log(`✅ 成功使用壓縮JSON格式加載拆分數據: ${a.size} 个字符`),m[t]=a,a}catch(s){console.warn("JSON格式加載失敗，回退到CSV格式:",s);try{const n=await C(r);return console.log(`⚠️ 使用CSV格式加載拆分數據: ${n.size} 個字符`),m[t]=n,n}catch(n){throw console.error("CSV格式也加載失敗:",n),n}}}export{k as C,C as a,P as b,K as c,m as d,R as f,I as m};
