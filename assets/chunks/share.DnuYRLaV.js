var F=Object.defineProperty;var Z=(r,t,s)=>t in r?F(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var g=(r,t,s)=>Z(r,typeof t!="symbol"?t+"":t,s);import{g as J}from"./framework.D5VGNaZP.js";const u=class u{constructor(t){g(this,"data",null);g(this,"loading",null);g(this,"dataUrl");g(this,"pakoLoaded",!1);this.dataUrl=t}async loadPako(){if(window.pako||this.pakoLoaded)return window.pako;try{const t=document.createElement("script");return t.src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js",t.crossOrigin="anonymous",await new Promise((s,n)=>{t.onload=s,t.onerror=n,document.head.appendChild(t)}),this.pakoLoaded=!0,window.pako}catch(t){return console.warn("Failed to load pako library:",t),null}}static getInstance(t="/chaifen.json"){return u.instances.has(t)||u.instances.set(t,new u(t)),u.instances.get(t)}async loadData(){return this.data?this.data:this.loading?this.loading:(this.loading=this.fetchOptimizedData(),this.data=await this.loading,this.loading=null,this.data)}async fetchOptimizedData(){const t=performance.now(),n=[{url:this.dataUrl.replace(".csv",".json"),compressed:!0},{url:this.dataUrl,compressed:!1,csv:!0}];for(const a of n)try{const e=await fetch(a.url,{headers:{Accept:"application/json, text/csv, */*","Accept-Charset":"utf-8"}});if(!e.ok)continue;let o;if(a.csv){const f=await e.arrayBuffer(),i=new TextDecoder("utf-8").decode(f);o=this.parseCsvToOptimized(i)}else if(a.compressed){const f=await e.arrayBuffer(),i=await this.decompressGzip(f),c=new TextDecoder("utf-8").decode(i);o=JSON.parse(c)}else{const f=await e.arrayBuffer(),i=new TextDecoder("utf-8").decode(f);o=JSON.parse(i)}const l=performance.now()-t;return console.log(`üìä Loaded ${a.url} in ${l.toFixed(2)}ms`),console.log(`üì¶ Data contains ${Object.keys(o).length} characters`),o}catch(e){console.warn(`Failed to load ${a.url}:`,e);continue}throw new Error("Failed to load chaifen data from any source")}parseCsvToOptimized(t){const s=t.split(`
`),n={};for(let a=1;a<s.length;a++){const e=s[a].trim();if(!e)continue;const[o,l,f,i]=e.split(",");if(o){const c={};l&&(c.d=l),f&&(c.dt=f),i&&(c.r=i),n[o]=c}}return n}search(t){var a,e;if(!this.data)return console.warn("Data not loaded yet"),[];const s=[],n=t.toLowerCase();if(t.length===1&&this.data[t]){const o=this.data[t];s.push({char:t,division:o.d,division_tw:o.dt,region:o.r})}for(const[o,l]of Object.entries(this.data))(o.includes(n)||(a=l.d)!=null&&a.toLowerCase().includes(n)||(e=l.dt)!=null&&e.toLowerCase().includes(n))&&s.push({char:o,division:l.d,division_tw:l.dt,region:l.r});return s}getChar(t){if(!this.data||!this.data[t])return null;const s=this.data[t];return{char:t,division:s.d,division_tw:s.dt,region:s.r}}async decompressGzip(t){try{const s=await this.loadPako();if(s){console.log("üì¶ Using pako for gzip decompression");const c=new Uint8Array(t);return s.inflate(c).buffer}if(console.log("üåê Using browser DecompressionStream for gzip decompression"),typeof DecompressionStream>"u")throw new Error("DecompressionStream not supported and pako not available");const a=new ReadableStream({start(c){c.enqueue(new Uint8Array(t)),c.close()}}).pipeThrough(new DecompressionStream("gzip")),e=[],o=a.getReader();for(;;){const{done:c,value:p}=await o.read();if(c)break;e.push(p)}const l=e.reduce((c,p)=>c+p.length,0),f=new Uint8Array(l);let i=0;for(const c of e)f.set(c,i),i+=c.length;return f.buffer}catch(s){throw console.error("Failed to decompress gzip data:",s),new Error(`Gzip decompression failed: ${s.message}`)}}};g(u,"instances",new Map);let k=u,m={};function I(r,t,s,n,a){var o,l,f,i,c,p,D,S,j,L,O,b,x,U,$,T,z,A;const e=[...r];if(n){let d=[];const h=e[0],y=e[e.length-1];e.length==1?d.push((((l=(o=t.get(h))==null?void 0:o.ma)==null?void 0:l[0])||"?").toUpperCase()):d.push((((i=(f=t.get(h))==null?void 0:f.ma)==null?void 0:i.slice(0,-1))||"?").toUpperCase()),d.push(...e.slice(1).map(w=>{var B,E;return(((E=(B=t.get(w))==null?void 0:B.ma)==null?void 0:E[0])||"?").toUpperCase()}));const v=w=>w.length===2?w[0].toUpperCase()+w[1]:w;return d.push(v(((p=(c=t.get(y))==null?void 0:c.ma)==null?void 0:p.slice(1))||"?")),d.join("").slice(0,5)}else if(a){let d=[];if(e.length>=1&&d.push(((S=(D=t.get(e[0]))==null?void 0:D.ma)==null?void 0:S[0])||"?"),e.length>=2&&d.push(((L=(j=t.get(e[1]))==null?void 0:j.ma)==null?void 0:L[0])||"?"),e.length>=3){const h=e[e.length-1];d.push(((b=(O=t.get(h))==null?void 0:O.ma)==null?void 0:b[0])||"?")}if(d.length<3){const h=e[e.length-1];d.push(((U=(x=t.get(h))==null?void 0:x.ma)==null?void 0:U[1])||"?")}return d.join("")}else{let d=e.map(h=>{var y,v;return((v=(y=t.get(h))==null?void 0:y.ma)==null?void 0:v[0])||"?"});if(d.length<4){const h=e[e.length-1];d.push(((T=($=t.get(h))==null?void 0:$.ma)==null?void 0:T[1])||"?")}if(d.length<4&&s){const h=e[0];d.push(((A=(z=t.get(h))==null?void 0:z.ma)==null?void 0:A[1])||"?")}return d.join("")}}async function C(r){if(r in m)return m[r];try{const s=await(await fetch(J(r))).text(),n=N(s);return m[r]=n,n}catch(t){throw t instanceof Error&&alert(`Êó†Ê≥ï‰∏ãËΩΩÊàñËß£Êûê„Ää${r}„ÄãÊñá‰ª∂Ôºö${t.cause}`),t}}function N(r){const t=r.split(`
`),n=t.shift().split(",").map(o=>o.trim()),a=n.length,e=new Map;for(let o of t){if(o=o.trim(),!o)continue;const l=o.split(",").map(i=>i.trim());if(l.length!==a)throw new Error(`CSVÊñá‰ª∂‰∏≠ ${o} Êï∞ÊçÆ‰∏çÂ§ü ${a} Êù°„ÄÇ`);const f={};for(let i=0;i<a;i++)f[n[i]]=l[i];e.set(l[0],f)}return e}async function P(r){return await C(r)}async function R(r){return await C(r)}async function K(r){const t=`optimized_${r}`;if(t in m)return m[t];try{const n=await k.getInstance(r).loadData(),a=new Map;for(const[e,o]of Object.entries(n))a.set(e,{char:e,division:o.d||"",division_tw:o.dt||"",region:o.r||""});return console.log(`‚úÖ ÊàêÂäü‰ΩøÁî®ÂéãÁº©JSONÊ†ºÂºèÂä†ËΩΩÊãÜÂàÜÊï∞ÊçÆ: ${a.size} ‰∏™Â≠óÁ¨¶`),m[t]=a,a}catch(s){console.warn("JSONÊ†ºÂºèÂä†ËΩΩÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞CSVÊ†ºÂºè:",s);try{const n=await C(r);return console.log(`‚ö†Ô∏è ‰ΩøÁî®CSVÊ†ºÂºèÂä†ËΩΩÊãÜÂàÜÊï∞ÊçÆ: ${n.size} ‰∏™Â≠óÁ¨¶`),m[t]=n,n}catch(n){throw console.error("CSVÊ†ºÂºè‰πüÂä†ËΩΩÂ§±Ë¥•:",n),n}}}export{k as C,C as a,P as b,K as c,m as d,R as f,I as m};
