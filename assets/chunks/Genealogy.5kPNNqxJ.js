import{d as st,l as Ae,y as at,v as rt,o as p,c as y,n as he,m as c,t as Y,a as re,e as N,a0 as be,F as U,C as Q,a3 as xe,a4 as lt,a5 as ze,p as je,k as T,j as k,R as it,_ as ct}from"./framework.72Ik0KeM.js";import{h as ut}from"./html2canvas-pro.esm.C4LuxvEu.js";async function dt(){try{const o=await fetch("/genealogy/schemas.json");if(!o.ok)throw new Error("Failed to load schemas data");return await o.json()}catch(o){return console.error("Error loading schemas:",o),[]}}function V(o){return parseInt(o.substring(0,4),10)}function ht(o){const s=parseInt(o.substring(0,4),10),r=parseInt(o.substring(4,6),10)||1,a=parseInt(o.substring(6,8),10)||1;return new Date(s,r-1,a)}function ft(o){const s=o.substring(0,4),r=o.substring(4,6),a=o.substring(6,8);return r==="00"?`${s}å¹´`:a==="00"?`${s}å¹´${parseInt(r)}æœˆ`:`${s}å¹´${parseInt(r)}æœˆ${parseInt(a)}æ—¥`}function qe(o){const s=o.substring(0,4),r=o.substring(4,6);return r==="00"?`${s}å¹´`:`${s}å¹´${parseInt(r)}æœˆ`}function Pe(o,s=!1){const r=[...o].sort((a,l)=>{const u=parseInt(a.date),d=parseInt(l.date);return u-d});return s?r.reverse():r}function mt(o,s=30,r=90,a=3,l=60){if(o.length===0)return new Map;const u=o.map(m=>V(m.date)),d=Math.min(...u),b=Math.max(...u),_=new Map;o.forEach(m=>{const v=V(m.date);_.set(v,(_.get(v)||0)+1)});const h=[];let S=null;for(let m=d;m<=b;m++)if((_.get(m)||0)===0)S===null&&(S=m);else if(S!==null){const g=m-S;g>=a&&h.push({startYear:S,endYear:m-1,length:g}),S=null}if(S!==null){const m=b-S+1;m>=a&&h.push({startYear:S,endYear:b,length:m})}const f=new Map;let i=0;for(let m=d;m<=b;m++){f.set(m,i);const v=_.get(m)||0,g=h.find(x=>m>=x.startYear&&m<=x.endYear);v>0?i+=s+v*r:g&&m===g.startYear?i+=l:g||(i+=s)}return f}function Xe(o,s,r=3,a=5){if(o.length===0)return[];const l=o.map(f=>V(f.date)),u=Math.min(...l),d=Math.max(...l),b=new Map;o.forEach(f=>{const i=V(f.date);b.set(i,(b.get(i)||0)+1)});for(let f=u;f<=d;f++)b.get(f);const _=[],h=5,S=2;for(let f=u;f<=d;f++){const i=s.get(f)||0;if(b.get(f),f%h===0||(f===u||f===d)){let g=!1;for(let x=f-S;x<=f+S;x++)if((b.get(x)||0)>0){g=!0;break}g&&_.push({year:f,y:i})}}return _}function vt(o,s,r,a=30,l=90,u){const d=V(o.date),b=ht(o.date),_=r.get(d)||0,h=new Date(d,0,1),f=new Date(d,11,31).getTime()-h.getTime(),m=(b.getTime()-h.getTime())/f;let v=a+l;if(u){const x=u.filter(F=>V(F.date)===d).length;x>0&&(v=a+x*l)}return _+m*v}function gt(o){const s=new Set;return o.forEach(r=>{r.features.forEach(a=>s.add(a))}),Array.from(s).sort()}function pt(o){const s=new Set;return o.forEach(r=>{r.authors.forEach(a=>s.add(a)),r.maintainers&&r.maintainers.forEach(a=>s.add(a))}),Array.from(s).sort()}function yt(o){if(o.length===0)return{minYear:0,maxYear:0};const s=o.map(r=>V(r.date));return{minYear:Math.min(...s),maxYear:Math.max(...s)}}function fe(o,s){let r=0;for(let a=0;a<o.length;a++){const l=o.charCodeAt(a);l>=19968&&l<=40959||l>=13312&&l<=19903||l>=131072&&l<=173791?s?r+=15:r+=12:s?r+=10:r+=7}return r}function wt(o){const s=fe(o.name,!0),r=fe(o.authors.join(" "),!1),a=o.maintainers?fe(o.maintainers.join(" "),!1):0,l=fe(qe(o.date),!1),u=Math.max(s,r,a,l);return Math.max(60,Math.min(350,u+10))}function bt(o,s,r,a){if(o.length===0)return[];const l=s.baseSpacing||30,u=s.schemaSpacing||90,d=s.nodeSpacing||20,b=s.width||1200,_=54,h=69,S=o.map(i=>({schema:i,y:vt(i,r,a,l,u,o),width:wt(i),height:i.maintainers?h:_}));return S.sort((i,m)=>i.y-m.y),xt(S,_,d,b)}function xt(o,s,r,a=1200){const l=[];if(o.length===0)return l;const u=80,d=50,b=a-u-d,_=4,h=b/_,S=(f,i)=>{const m=f.id+f.name+f.authors.join("")+f.date;let v=0;for(let g=0;g<m.length;g++)v=(v<<5)-v+m.charCodeAt(g),v=v&v;return v=Math.abs(v*2654435761),v=Math.abs(v*1597334677),v%i-i/2};return o.forEach((f,i)=>{const m=(i+1)%_,v=u+h*m+h/2,g=h*.6,x=S(f.schema,g),F=v+x-f.width/2,H=Math.max(u,Math.min(F,a-d-f.width));l.push({schema:f.schema,x:H,y:f.y+50,width:f.width,height:f.height})}),l}function Ct(o){const s=[],r=kt(o);s.push(...r);const a=_t(o);s.push(...a);const l=St(o,s);return s.push(...l),s}function kt(o){const s=[],r=new Map;for(const a of o)for(const l of a.features){const u=r.get(l);u?u!==a.id&&s.push({from:a.id,to:u,type:"feature",label:l}):r.set(l,a.id)}return s}function _t(o){const s=[],r=new Map;for(const a of o){const l=[...a.authors];a.maintainers&&l.push(...a.maintainers);for(const u of l){const d=r.get(u)||[];for(const b of d)s.push({from:a.id,to:b,type:"author",label:u});r.has(u)||r.set(u,[]),r.get(u).push(a.id)}}return s}function St(o,s){const r=[],a=new Set;s.forEach(l=>{a.add(`${l.from}-${l.to}`),a.add(`${l.to}-${l.from}`)});for(let l=0;l<o.length;l++)for(let u=l+1;u<o.length;u++){const d=o[l],b=o[u];if(a.has(`${d.id}-${b.id}`)||a.has(`${b.id}-${d.id}`))continue;const _=new Set([...d.authors,...d.maintainers||[]]),h=new Set([...b.authors,...b.maintainers||[]]);if([..._].some(x=>h.has(x)))continue;const f=new Set(d.features),i=new Set(b.features),m=[...f].filter(x=>!i.has(x)),v=[...i].filter(x=>!f.has(x)),g=m.length+v.length;if(m.length<=1&&v.length<=1){let x="ç›¸ä¼¼";g>1?x=`${[...m,...v].join(" å° ")}`:g===1?x=`${m.length>0?m[0]:v[0]} ä¸åŒ`:g===0&&(x="é«˜åº¦ç›¸ä¼¼");const[F,H]=V(d.date)>V(b.date)?[d.id,b.id]:[b.id,d.id];r.push({from:F,to:H,type:"similar",label:x})}}return r}function $t(o){const s=o.filter(d=>d.type==="feature"),r=o.filter(d=>d.type==="author"),a=o.filter(d=>d.type==="similar"),l=new Map,u=new Map;for(const d of s)l.set(d.label,(l.get(d.label)||0)+1);for(const d of r)u.set(d.label,(u.get(d.label)||0)+1);return{total:o.length,featureConnections:s.length,authorConnections:r.length,similarConnections:a.length,byFeature:l,byAuthor:u}}function Et(o,s,r,a,l=.5){const u=(s+a)/2,d=o,b=u-(a-s)*0,_=r,h=u+(a-s)*0;return`M ${o},${s} C ${d},${b} ${_},${h} ${r},${a}`}function Oe(o,s="center"){switch(s){case"top":return{x:o.x+o.width/2,y:o.y};case"bottom":return{x:o.x+o.width/2,y:o.y+o.height};case"left":return{x:o.x,y:o.y+o.height/2};case"right":return{x:o.x+o.width,y:o.y+o.height/2};case"center":default:return{x:o.x+o.width/2,y:o.y+o.height/2}}}function Mt(o,s){const r=s.get(o.from),a=s.get(o.to);if(!r||!a)return null;const l=Oe(r,"top"),u=Oe(a,"bottom");return Et(l.x,l.y,u.x,u.y,.3)}function Yt(o,s="light"){return o.type==="feature"?s==="light"?"rgba(99, 102, 241, 0.5)":"rgba(165, 180, 252, 0.5)":o.type==="author"?s==="light"?"rgba(34, 197, 94, 0.5)":"rgba(134, 239, 172, 0.5)":o.type==="similar"?s==="light"?"rgba(71, 85, 105, 0.5)":"rgba(226, 232, 240, 0.5)":"rgba(156, 163, 175, 0.5)"}function Ft(o,s=!1){return s?3:2}function Tt(o,s){const r=[];for(const a of o){const l=Mt(a,s);l&&r.push({connection:a,path:l})}return r}class Wt{static generateFileName(){return`æ¼¢å­—å­—å½¢è¼¸å…¥æ³•ç¹«çµ¡åœ–${new Date().toISOString().split("T")[0].replace(/-/g,"")}.png`}static addTemporaryWatermark(s,r=null){const a=document.createElement("div");a.className="genealogy-export-watermark";const l=document.documentElement.classList.contains("dark"),u=l?"rgb(165, 180, 252)":"#4f46e5",d=r?"space-between":"center",b=s.querySelector("svg"),_=b?b.getAttribute("width"):"840";if(a.style.cssText=`
            width: ${_}px;   // ä½¿ç”¨ SVG çš„å¯¦éš›å¯¬åº¦
            padding: 4px 32px;      // ä¸Šä¸‹ã€å·¦å³ï¼ˆæ§åˆ¶åˆ°å…©å´é‚Šç·£çš„è·é›¢ï¼‰
            background: transparent;
            margin-top: 4px;        // é è…³ï¼ˆåº•éƒ¨ä¿¡æ¯ï¼‰ä¸Šæ–¹åˆ°ç•«å¸ƒçš„è·é›¢
            font-family: 'Noto Serif SC', serif;
            display: flex;
            justify-content: ${d};
            align-items: center;
            gap: 2rem;
            box-sizing: border-box; // ç¢ºä¿ padding åŒ…å«åœ¨å¯¬åº¦å…§
        `,r){const h=document.createElement("div");h.style.cssText=`
                flex: 0.75;               // å·¦å´å¯¬åº¦å’Œå³å´å¯¬åº¦ä¹‹æ¯”ï¼ˆå·¦å³æ¯”ï¼‰
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
                font-family: 'Noto Serif SC', serif;
                font-size: 0.85rem;
                color: ${u};
                font-weight: 400;
                justify-content: center;
            `,h.innerHTML=`
                <div style="font-weight: 600;">å®‡æµ©ç³»åˆ—è¼¸å…¥æ³•</div>
                <div>å®˜ç¶²ï¼šshurufa.app</div>
                <div>QQ è¨è«–ç¾¤ï¼š170510762</div>
            `;const S=document.createElement("div"),f="rgba(99, 102, 241, 0.95)",i="white",m="rgba(255, 255, 255, 0.3)";S.style.cssText=`
                flex: 1;
                padding: 0.75rem 1.25rem;
                background: ${f};
                color: ${i};
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            `;let v=`<div style="font-family: 'Noto Serif SC'; font-size: 1.2rem; font-weight: 900; line-height: 1.2; display: flex; align-items: center; gap: 0.5rem;">${r.name}`;r.url&&(v+=` <a href="${r.url}" target="_blank" style="color: inherit; text-decoration: none; opacity: 0.7; font-size: 0.875rem;">ğŸ”—</a>`),v+="</div>";let g="";r.maintainers&&r.maintainers.length>0&&(g=`<div style="font-size: 0.875rem; opacity: 0.9;">${r.maintainers.join("ã€")} (ä¿®è¨‚ç¶­è­·)</div>`);const x=`<div style="font-size: 0.875rem; opacity: 0.9;">${r.authors.join("ã€")}</div>`,F=`<div style="font-size: 0.875rem; opacity: 0.8;">${r.date}</div>`;let H="";if(r.features&&r.features.length>0){const j="rgba(255, 255, 255, 0.2)";H=`<div style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-top: 0.25rem;">${r.features.map(O=>`<span style="display: inline-block; padding: 0.125rem 0.5rem; background: ${j}; border-radius: 0.25rem; font-size: 0.75rem; white-space: nowrap;">${O}</span>`).join("")}</div>`}let L="";r.description&&(L=`<div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.25rem; padding-top: 0.5rem; border-top: 1px solid ${m};">${r.description}</div>`),S.innerHTML=v+g+x+F+H+L,a.appendChild(h),a.appendChild(S)}else{const h=document.createElement("div");h.style.cssText=`
                text-align: center;
                font-family: 'Noto Serif SC', serif;
                font-size: 0.85rem;
                color: ${u};
                font-weight: 400;
            `,h.textContent="å®‡æµ©ç³»åˆ—è¼¸å…¥æ³• Â· å®˜ç¶²: shurufa.app Â· QQ è¨è«–ç¾¤: 170510762",a.appendChild(h)}return s.appendChild(a),a}static removeTemporaryWatermark(s){s&&s.parentNode&&s.parentNode.removeChild(s)}static async exportGenealogyToPNG(s,r={}){const{copyToClipboard:a=!1,download:l=!0,scale:u=2,addWatermark:d=!0,focusedSchemaDetails:b=null}=r;if(!s.querySelector("svg"))throw new Error("æ‰¾ä¸åˆ° SVG å…ƒç´ ");const h=s.closest(".genealogy-content");if(!h)throw new Error("æ‰¾ä¸åˆ° genealogy-content å®¹å™¨");const f=window.getComputedStyle(s).backgroundColor||"#ffffff";document.documentElement.classList.contains("dark");let i=null;d&&(i=this.addTemporaryWatermark(h,b));let m=null,v="",g=null,x="";try{m=h.querySelector(".toolbar-compact"),m&&(v=m.style.display,m.style.display="none"),g=h.querySelector(".floating-hint"),g&&(x=g.style.display,g.style.display="none");const F=document.createElement("div");F.className="export-title";const H=document.documentElement.classList.contains("dark");F.style.cssText=`
                text-align: center;
                font-size: 1.8rem;
                font-weight: bold;
                margin-bottom: 0.25rem;  // æ¨™é¡Œä¸‹æ–¹åˆ°ç•«å¸ƒçš„è·é›¢
                padding: 0.25rem;        // æ¨™é¡Œå…§éƒ¨çš„ä¸Šä¸‹å…§é‚Šè·
                color: ${H?"rgb(165, 180, 252)":"#5400a2ff"};
                background: transparent;
                font-family: 'Noto Serif SC', serif;
            `,F.textContent="æ¼¢å­—å­—å½¢è¼¸å…¥æ³•ç¹«çµ¡åœ–",h.insertBefore(F,h.firstChild),await new Promise(E=>setTimeout(E,500));const L=h.getBoundingClientRect(),j=Math.max(L.width,h.scrollWidth),Z=Math.max(L.height,h.scrollHeight),O=await ut(h,{backgroundColor:f,scale:u,useCORS:!0,allowTaint:!1,logging:!0,width:j,height:Z,windowWidth:j,windowHeight:Z,scrollX:0,scrollY:0,x:0,y:0,ignoreElements:E=>E.classList.contains("toolbar-compact")||E.classList.contains("floating-hint")||E.classList.contains("dropdown-menu"),foreignObjectRendering:!1,removeContainer:!1,imageTimeout:15e3});this.restoreAllChanges(m,v,g,x,h.querySelector(".export-title"));const A=O.toDataURL("image/png",1),P=this.generateFileName();if(a&&this.isClipboardSupported())try{const E=await new Promise(X=>{O.toBlob(te=>{te&&X(te)},"image/png",1)});await navigator.clipboard.write([new ClipboardItem({"image/png":E})]),console.log("ç¹«çµ¡åœ–å·²è¤‡è£½åˆ°å‰ªè²¼æ¿")}catch(E){console.warn("è¤‡è£½åˆ°å‰ªè²¼æ¿å¤±æ•—:",E)}if(l){const E=document.createElement("a");E.download=P,E.href=A,E.style.display="none",document.body.appendChild(E),E.click(),document.body.removeChild(E),console.log("ç¹«çµ¡åœ–å·²ä¸‹è¼‰:",P)}return{success:!0,message:a&&this.isClipboardSupported()?"ç¹«çµ¡åœ–å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ä¸¦ä¸‹è¼‰":"ç¹«çµ¡åœ–å·²ä¸‹è¼‰",dataUrl:A,filename:P}}catch(F){return console.error("å°å‡ºç¹«çµ¡åœ–å¤±æ•—:",F),this.restoreAllChanges(m,v,g,x,h==null?void 0:h.querySelector(".export-title")),{success:!1,message:`å°å‡ºå¤±æ•—: ${F instanceof Error?F.message:"æœªçŸ¥éŒ¯èª¤"}`,dataUrl:"",filename:""}}finally{i&&this.removeTemporaryWatermark(i)}}static restoreAllChanges(s,r,a,l,u){s&&(s.style.display=r),a&&(a.style.display=l),u&&u.parentNode&&u.remove()}static isClipboardSupported(){return typeof navigator<"u"&&"clipboard"in navigator&&"write"in navigator.clipboard}}const Nt={key:0,class:"loading-state"},It={key:1,class:"error-state"},Dt={key:2,class:"genealogy-content"},Lt={class:"toolbar-compact"},Ht={class:"toolbar-header"},At={class:"toolbar-stats"},zt={class:"toolbar-controls"},jt={class:"toolbar-left"},Pt={class:"dropdown-wrapper"},Xt={key:0,class:"badge"},Ot={class:"dropdown-header"},qt=["checked","onChange"],Rt={class:"dropdown-wrapper"},Gt={key:0,class:"badge"},Vt={class:"dropdown-header"},Ut=["checked","onChange"],Qt={class:"dropdown-wrapper"},Jt={key:0,class:"badge"},Kt={class:"dropdown-header"},Zt=["checked","onChange"],Bt={class:"toolbar-right"},en={class:"scale-control-inline"},tn=["disabled","title"],nn=["title"],on={key:1,class:"export-message"},sn=["width","height"],an={id:"arrow-feature",viewBox:"0 0 10 10",refX:"9",refY:"5",markerWidth:"5",markerHeight:"3",orient:"auto"},rn=["fill"],ln={id:"arrow-author",viewBox:"0 0 10 10",refX:"9",refY:"5",markerWidth:"3",markerHeight:"3",orient:"auto"},cn=["fill"],un={id:"arrow-similar",viewBox:"0 0 10 10",refX:"9",refY:"5",markerWidth:"3",markerHeight:"3",orient:"auto"},dn=["fill"],hn={class:"connections"},fn=["onMouseenter","onMouseleave","onClick"],mn=["d","stroke","stroke-width","marker-end","stroke-dasharray"],vn={class:"year-labels"},gn=["y2"],pn=["y"],yn={class:"schema-nodes-all"},wn=["transform","onMousedown"],bn=["width","height"],xn={x:10,y:16,class:"node-name","text-anchor":"start","shape-rendering":"crispEdges","text-rendering":"geometricPrecision"},Cn={key:0,x:10,y:31,class:"node-author","text-anchor":"start","shape-rendering":"crispEdges","text-rendering":"geometricPrecision"},kn=["y"],_n=["y"],Sn={key:0,class:"drag-ghost"},$n=["transform"],En=["width","height"],Mn={key:1,class:"connection-labels"},Yn=["onMouseenter","onClick"],Fn=["x","y","width","height"],Tn=["x","y"],Wn={key:2,class:"floating-hint"},Nn={key:0,class:"schema-details"},In={class:"schema-details-name"},Dn=["href"],Ln={key:0,class:"schema-details-maintainers"},Hn={class:"schema-details-authors"},An={class:"schema-details-date"},zn={class:"schema-details-features"},jn={key:1,class:"schema-details-description"},Pn={class:"hint-text"},Xn={key:0},On={key:1},qn={key:2},Rn=st({__name:"Genealogy",props:{config:{default:()=>({})}},setup(o){const s=o,r={width:840,height:1200,nodeSpacing:10,baseSpacing:15,schemaSpacing:35,emptyYearThreshold:3,emptySegmentSpacing:30,labelInterval:5,reverseTimeline:!1,showDeprecated:!0,highlightFeatures:[]},a=T(()=>({...r,...s.config})),l=k([]),u=k([]),d=k(!0),b=k(null),_=k(0),h=k(0),S=k([]),f=k([]),i=k(null),m=k(null),v=k(null),g=k(null),x=k(null),F=k(0),H=k(0),L=k(null),j=k(!1),Z=k(new Map),O=k(!1),A=k(null),P=k(.64),q=k([]),E=k([]),X=k([]),te=k(""),ne=k(!1),oe=k(!1),se=k(!1),R=k([]),Ce=k(null),B=k(!1),J=k(""),me=k(null),ee=k(!1),ke=()=>{typeof document<"u"&&(ee.value=document.documentElement.classList.contains("dark"),console.log("Theme updated:",ee.value?"dark":"light",document.documentElement.className))};Ae(()=>{ke(),new MutationObserver(ke).observe(document.documentElement,{attributes:!0,attributeFilter:["class"]})});const le=T(()=>{let n=l.value;if(a.value.showDeprecated||(n=n.filter(t=>!t.deprecated)),q.value.length>0&&(n=n.filter(t=>q.value.includes(t.id))),E.value.length>0&&(n=n.filter(t=>E.value.some(e=>t.features.includes(e)))),X.value.length>0&&(n=n.filter(t=>X.value.some(e=>t.authors.includes(e)||t.maintainers&&t.maintainers.includes(e)))),te.value){const t=te.value.toLowerCase();n=n.filter(e=>{var C;return e.name.toLowerCase().includes(t)||e.authors.some(w=>w.toLowerCase().includes(t))||e.maintainers&&e.maintainers.some(w=>w.toLowerCase().includes(t))||((C=e.description)==null?void 0:C.toLowerCase().includes(t))})}return n}),_e=T(()=>Pe(l.value,!1)),Re=T(()=>{if(i.value){const n=new Set([i.value]);return R.value.forEach(t=>{t.from===i.value&&n.add(t.to),t.to===i.value&&n.add(t.from)}),le.value.forEach(t=>n.add(t.id)),n}return new Set(le.value.map(n=>n.id))}),ae=T(()=>l.value.length===0?new Map:mt(l.value,a.value.baseSpacing||30,a.value.schemaSpacing||90,a.value.emptyYearThreshold||3,a.value.emptySegmentSpacing||60));function ve(n){return Re.value.has(n)}function Ge(n){return le.value.some(t=>t.id===n)}function Ve(n){return ve(n.from)&&ve(n.to)}const ie=T(()=>_e.value.length===0||_.value===0?[]:bt(_e.value,a.value,_.value,ae.value)),Se=T(()=>{if(_.value===0||h.value===0||ae.value.size===0)return(a.value.height||1200)*P.value;if(ie.value.length>0)return(Math.max(...ie.value.map(G=>G.y+G.height))+100+150)*P.value;const n=ae.value.get(h.value)||0,t=a.value.baseSpacing||30,e=a.value.schemaSpacing||90,C=100,w=150,I=l.value.filter(D=>V(D.date)===h.value).length,W=I>0?t+I*e:t;return(n+W+C+w)*P.value}),ge=T(()=>ie.value.map(n=>{const t=Z.value.get(n.schema.id)||0;return{...n,x:n.x+t,y:n.y*P.value}})),Ue=T(()=>u.value.map(n=>({...n,y:n.y*P.value}))),pe=T(()=>{const n=new Map;return ge.value.forEach(t=>{n.set(t.schema.id,t)}),n}),$e=T(()=>{if(!i.value)return new Set;const n=new Set;return R.value.forEach(t=>{t.from===i.value&&n.add(t.to)}),n}),Ee=T(()=>{if(!i.value)return new Set;const n=new Set;return R.value.forEach(t=>{t.to===i.value&&n.add(t.from)}),n}),Me=T(()=>{if(!i.value)return new Set;const n=new Set;return R.value.forEach(t=>{t.type==="similar"&&(t.from===i.value?n.add(t.to):t.to===i.value&&n.add(t.from))}),n}),Ye=T(()=>R.value.length===0?[]:Tt(R.value,pe.value)),Fe=T(()=>Ye.value.filter(({connection:n})=>!(Ce.value&&n.type!==Ce.value))),Te=T(()=>{const n=ee.value?"dark":"light",t=i.value,e=v.value,C=g.value;return Fe.value.map(({connection:w,path:I})=>{const W=t===w.from,D=t===w.to,$=w.type==="similar"&&(w.from===t||w.to===t),M=W||D||$,G=!e&&!C&&M||(e==null?void 0:e.from)===w.from&&(e==null?void 0:e.to)===w.to||(C==null?void 0:C.from)===w.from&&(C==null?void 0:C.to)===w.to,ue=e||C?!((e==null?void 0:e.from)===w.from&&(e==null?void 0:e.to)===w.to||(C==null?void 0:C.from)===w.from&&(C==null?void 0:C.to)===w.to):t&&!M;return{connection:w,path:I,strokeColor:Yt(w,n),strokeWidth:Ft(w,G),isParent:W,isChild:D,isSimilar:$,isFocused:M&&!e&&!C||G,isDimmed:ue}})}),Qe=T(()=>{const n=[];return Fe.value.forEach(({connection:t,path:e})=>{n.push({connection:t,path:e,label:t.label})}),n}),We=T(()=>{if(!i.value)return[];const t=Qe.value.filter(w=>(w.connection.from===i.value||w.connection.to===i.value)&&w.connection.type!=="author").map(w=>{const I=pe.value.get(w.connection.from),W=pe.value.get(w.connection.to);if(!I||!W)return null;const D=I.x+I.width/2,$=I.y,M=W.x+W.width/2,G=W.y+W.height,we=Ke(w.label)+16;return{connection:w.connection,label:w.label,x:(D+M)/2,y:($+G)/2,width:we,height:18,lineStartX:D,lineStartY:$,lineEndX:M,lineEndY:G,offset:.5}}).filter(Boolean),e=4,C=10;for(let w=0;w<C;w++){let I=!1;for(let W=0;W<t.length;W++)for(let D=W+1;D<t.length;D++){const $=t[W],M=t[D],G=Math.abs($.x-M.x),ue=Math.abs($.y-M.y),we=($.width+M.width)/2+e,He=($.height+M.height)/2+e;if(G<we&&ue<He){I=!0;const de=.1;W%2===0?($.offset=Math.max(.2,$.offset-de),M.offset=Math.min(.8,M.offset+de)):($.offset=Math.min(.8,$.offset+de),M.offset=Math.max(.2,M.offset-de)),$.x=$.lineStartX+($.lineEndX-$.lineStartX)*$.offset,$.y=$.lineStartY+($.lineEndY-$.lineStartY)*$.offset,M.x=M.lineStartX+(M.lineEndX-M.lineStartX)*M.offset,M.y=M.lineStartY+(M.lineEndY-M.lineStartY)*M.offset}}if(!I)break}return t}),ye=T(()=>R.value.length===0?{total:0,featureConnections:0,authorConnections:0,similarConnections:0,byFeature:new Map,byAuthor:new Map}:$t(R.value)),z=T(()=>i.value&&l.value.find(n=>n.id===i.value)||null);async function Ne(){d.value=!0,b.value=null;try{const n=await dt();if(n.length===0)throw new Error("ç„¡æ³•åŠ è¼‰æ•¸æ“š");l.value=n;const t=yt(n);_.value=t.minYear,h.value=t.maxYear,u.value=Xe(n,ae.value,a.value.emptyYearThreshold||3,a.value.labelInterval||5),S.value=gt(n),f.value=pt(n);const e=Pe(n,!1);R.value=Ct(e),console.log("æ•¸æ“šåŠ è¼‰å®Œæˆ:",{ç¸½æ•¸:n.length,å¹´ä»½ç¯„åœ:`${_.value}-${h.value}`,ç‰¹æ€§æ•¸:S.value.length,ä½œè€…æ•¸:f.value.length,é€£æ¥æ•¸:R.value.length,ç‰¹æ€§é€£æ¥:ye.value.featureConnections,ä½œè€…é€£æ¥:ye.value.authorConnections,ç›¸ä¼¼é€£æ¥:ye.value.similarConnections})}catch(n){b.value=n instanceof Error?n.message:"åŠ è¼‰å¤±æ•—",console.error("åŠ è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯:",n)}finally{d.value=!1}}function Je(n){const t=performance.now();i.value===n?(i.value=null,g.value=null):(i.value=n,g.value=null),it(()=>{const C=performance.now()-t;console.log(`é—œæ³¨æ¨¡å¼åˆ‡æ›è€—æ™‚: ${C.toFixed(2)}ms`,{é€£æ¥æ•¸:Ye.value.length,æ¸²æŸ“ç·©å­˜:Te.value.length,æ¨™ç±¤æ•¸:We.value.length,ç¯€é»æ•¸:ge.value.length})})}function ce(n){g.value||(v.value=n)}function Ie(n){g.value&&g.value.from===n.from&&g.value.to===n.to?g.value=null:(g.value=n,v.value=null)}function Ke(n){let t=0;for(let e=0;e<n.length;e++){const C=n.charCodeAt(e);C>=19968&&C<=40959||C>=13312&&C<=19903||C>=131072&&C<=173791?t+=12:t+=6.5}return t}function Ze(n){const t=q.value.indexOf(n);t>-1?q.value.splice(t,1):q.value.push(n)}function Be(n){const t=E.value.indexOf(n);t>-1?E.value.splice(t,1):E.value.push(n)}function et(n){const t=X.value.indexOf(n);t>-1?X.value.splice(t,1):X.value.push(n)}function tt(n,t){F.value=n.clientX,H.value=n.clientX,x.value=t,L.value=window.setTimeout(()=>{j.value=!0,document.body.style.cursor="grabbing"},200)}function De(n){x.value&&(H.value=n.clientX,j.value&&n.preventDefault())}function Le(){if(L.value!==null&&(clearTimeout(L.value),L.value=null),j.value&&x.value){const n=H.value-F.value,t=Z.value.get(x.value)||0;Z.value.set(x.value,t+n),document.body.style.cursor=""}else x.value&&Je(x.value);j.value=!1,x.value=null}function nt(){A.value&&(O.value?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():A.value.requestFullscreen?A.value.requestFullscreen():A.value.webkitRequestFullscreen?A.value.webkitRequestFullscreen():A.value.mozRequestFullScreen?A.value.mozRequestFullScreen():A.value.msRequestFullscreen&&A.value.msRequestFullscreen())}function K(){O.value=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)}async function ot(){if(!(B.value||!me.value)){B.value=!0,J.value="";try{const n=await Wt.exportGenealogyToPNG(me.value,{copyToClipboard:!1,download:!0,scale:2,addWatermark:!0,focusedSchemaDetails:z.value});n.success?(J.value=n.message,console.log("ç¹«çµ¡åœ–å°å‡ºæˆåŠŸ:",n.filename)):(J.value=n.message,console.error("ç¹«çµ¡åœ–å°å‡ºå¤±æ•—:",n.message)),setTimeout(()=>{J.value=""},3e3)}catch(n){J.value=`å°å‡ºå¤±æ•—: ${n instanceof Error?n.message:"æœªçŸ¥éŒ¯èª¤"}`,console.error("å°å‡ºç¹«çµ¡åœ–æ™‚å‡ºéŒ¯:",n),setTimeout(()=>{J.value=""},5e3)}finally{B.value=!1}}}return Ae(()=>{Ne(),document.addEventListener("mousemove",De),document.addEventListener("mouseup",Le),document.addEventListener("fullscreenchange",K),document.addEventListener("webkitfullscreenchange",K),document.addEventListener("mozfullscreenchange",K),document.addEventListener("MSFullscreenChange",K)}),at(()=>{document.removeEventListener("mousemove",De),document.removeEventListener("mouseup",Le),document.removeEventListener("fullscreenchange",K),document.removeEventListener("webkitfullscreenchange",K),document.removeEventListener("mozfullscreenchange",K),document.removeEventListener("MSFullscreenChange",K),L.value!==null&&clearTimeout(L.value)}),rt(()=>s.config,()=>{u.value=Xe(l.value,ae.value,a.value.emptyYearThreshold||3,a.value.labelInterval||5)},{deep:!0}),(n,t)=>(p(),y("div",{ref_key:"genealogyContainer",ref:A,class:he(["genealogy-container",{"fullscreen-mode":O.value}])},[d.value?(p(),y("div",Nt,[...t[12]||(t[12]=[c("div",{class:"loading-spinner"},null,-1),c("p",null,"åŠ è¼‰ä¸­...",-1)])])):b.value?(p(),y("div",It,[c("p",null,Y(b.value),1),c("button",{onClick:Ne,class:"btn btn-sm btn-primary"},"é‡è©¦")])):(p(),y("div",Dt,[c("div",Lt,[c("div",Ht,[t[13]||(t[13]=c("h2",{class:"toolbar-title"},"æ¼¢å­—å­—å½¢è¼¸å…¥æ³•ç¹«çµ¡åœ–",-1)),c("span",At," å…± "+Y(le.value.length)+" å€‹è¼¸å…¥æ³• ("+Y(_.value)+"-"+Y(h.value)+") ",1)]),c("div",zt,[c("div",jt,[c("div",Pt,[c("button",{onClick:t[0]||(t[0]=e=>ne.value=!ne.value),class:"dropdown-trigger"},[t[14]||(t[14]=re(" æ–¹æ¡ˆ ",-1)),q.value.length>0?(p(),y("span",Xt,Y(q.value.length),1)):N("",!0),t[15]||(t[15]=c("span",{class:"arrow"},"â–¼",-1))]),ne.value?(p(),y("div",{key:0,class:"dropdown-menu",onClick:t[2]||(t[2]=be(()=>{},["stop"]))},[c("div",Ot,[c("button",{onClick:t[1]||(t[1]=e=>q.value=[]),class:"clear-btn"},"æ¸…é™¤")]),(p(!0),y(U,null,Q(l.value,e=>(p(),y("label",{key:e.id,class:"dropdown-item"},[c("input",{type:"checkbox",checked:q.value.includes(e.id),onChange:C=>Ze(e.id)},null,40,qt),c("span",null,Y(e.name),1)]))),128))])):N("",!0)]),c("div",Rt,[c("button",{onClick:t[3]||(t[3]=e=>se.value=!se.value),class:"dropdown-trigger"},[t[16]||(t[16]=re(" ä½œè€… ",-1)),X.value.length>0?(p(),y("span",Gt,Y(X.value.length),1)):N("",!0),t[17]||(t[17]=c("span",{class:"arrow"},"â–¼",-1))]),se.value?(p(),y("div",{key:0,class:"dropdown-menu",onClick:t[5]||(t[5]=be(()=>{},["stop"]))},[c("div",Vt,[c("button",{onClick:t[4]||(t[4]=e=>X.value=[]),class:"clear-btn"},"æ¸…é™¤")]),(p(!0),y(U,null,Q(f.value,e=>(p(),y("label",{key:e,class:"dropdown-item"},[c("input",{type:"checkbox",checked:X.value.includes(e),onChange:C=>et(e)},null,40,Ut),c("span",null,Y(e),1)]))),128))])):N("",!0)]),c("div",Qt,[c("button",{onClick:t[6]||(t[6]=e=>oe.value=!oe.value),class:"dropdown-trigger"},[t[18]||(t[18]=re(" ç‰¹å¾µ ",-1)),E.value.length>0?(p(),y("span",Jt,Y(E.value.length),1)):N("",!0),t[19]||(t[19]=c("span",{class:"arrow"},"â–¼",-1))]),oe.value?(p(),y("div",{key:0,class:"dropdown-menu",onClick:t[8]||(t[8]=be(()=>{},["stop"]))},[c("div",Kt,[c("button",{onClick:t[7]||(t[7]=e=>E.value=[]),class:"clear-btn"},"æ¸…é™¤")]),(p(!0),y(U,null,Q(S.value,e=>(p(),y("label",{key:e,class:"dropdown-item"},[c("input",{type:"checkbox",checked:E.value.includes(e),onChange:C=>Be(e)},null,40,Zt),c("span",null,Y(e),1)]))),128))])):N("",!0)])]),c("div",Bt,[c("div",en,[xe(c("input",{type:"range","onUpdate:modelValue":t[9]||(t[9]=e=>P.value=e),min:"0.25",max:"1.0",step:"0.05",class:"scale-slider-inline"},null,512),[[lt,P.value,void 0,{number:!0}]])]),c("button",{onClick:ot,class:"btn-compact export-btn",disabled:B.value,title:B.value?"æ­£åœ¨å°å‡º...":"æˆªåœ–ä¸‹è¼‰ç•¶å‰å¯è¦‹çš„ç¹«çµ¡åœ–"},Y(B.value?"â³":"ğŸ“·"),9,tn),c("button",{onClick:nt,class:"btn-compact",title:O.value?"é€€å‡ºå…¨å± (ESC)":"é€²å…¥å…¨å±"},Y(O.value?"âœ• é€€å‡º":"â›¶"),9,nn)])])]),ne.value||oe.value||se.value?(p(),y("div",{key:0,class:"dropdown-backdrop",onClick:t[10]||(t[10]=e=>{ne.value=!1,oe.value=!1,se.value=!1})})):N("",!0),J.value?(p(),y("div",on,Y(J.value),1)):N("",!0),c("div",{ref_key:"canvasWrapper",ref:me,class:"canvas-wrapper"},[(p(),y("svg",{width:a.value.width,height:Se.value,class:"genealogy-svg"},[c("defs",null,[c("marker",an,[c("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:ee.value?"rgba(165, 180, 252, 0.6)":"rgba(99, 102, 241, 0.6)"},null,8,rn)]),c("marker",ln,[c("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:ee.value?"rgba(134, 239, 172, 0.6)":"rgba(34, 197, 94, 0.6)"},null,8,cn)]),c("marker",un,[c("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:ee.value?"rgba(251, 191, 36, 0.8)":"rgba(245, 158, 11, 0.7)"},null,8,dn)])]),c("g",hn,[(p(!0),y(U,null,Q(Te.value,(e,C)=>xe((p(),y("g",{key:`${e.connection.from}-${e.connection.to}-${e.connection.type}-${C}`,onMouseenter:w=>i.value&&!e.isDimmed&&ce(e.connection),onMouseleave:w=>i.value&&!e.isDimmed&&ce(null),onClick:w=>i.value&&!e.isDimmed&&Ie(e.connection)},[c("path",{d:e.path,stroke:e.strokeColor,"stroke-width":e.strokeWidth,fill:"none","marker-end":e.connection.type!=="similar"?`url(#arrow-${e.connection.type})`:void 0,"stroke-dasharray":e.connection.type==="similar"?"5, 5":e.connection.type==="author"?"10, 6":"none",class:he({"connection-line":!0,[`connection-${e.connection.type}`]:!0,"connection-parent":e.isParent,"connection-child":e.isChild,"connection-similar":e.isSimilar,"connection-focused":e.isFocused,"connection-dimmed":e.isDimmed,"connection-interactive":!e.isDimmed})},[c("title",null,Y(e.connection.label),1)],10,mn)],40,fn)),[[ze,Ve(e.connection)]])),128))]),c("g",vn,[c("line",{x1:50,y1:50,x2:50,y2:Se.value-50,class:"timeline-axis"},null,8,gn),(p(!0),y(U,null,Q(Ue.value,e=>(p(),y("text",{key:e.year,x:40,y:e.y+54,class:"year-label-text","text-anchor":"end"},Y(e.year),9,pn))),128))]),c("g",yn,[(p(!0),y(U,null,Q(ge.value,e=>xe((p(),y("g",{key:e.schema.id,transform:`translate(${e.x}, ${e.y})`,onMousedown:C=>tt(C,e.schema.id),class:he(["schema-node",{hovered:m.value===e.schema.id,"schema-node-dimmed":i.value&&e.schema.id!==i.value&&!$e.value.has(e.schema.id)&&!Ee.value.has(e.schema.id)&&!Me.value.has(e.schema.id),"schema-node-parent":i.value&&$e.value.has(e.schema.id),"schema-node-child":i.value&&Ee.value.has(e.schema.id),"schema-node-similar":i.value&&Me.value.has(e.schema.id),"schema-node-extended":i.value&&!Ge(e.schema.id),focused:i.value===e.schema.id,dragging:j.value&&x.value===e.schema.id}])},[c("rect",{width:e.width,height:e.height,class:"node-bg",rx:"8"},null,8,bn),c("text",xn,Y(e.schema.name),1),e.schema.maintainers?(p(),y("text",Cn,Y(e.schema.maintainers.join(" ")),1)):N("",!0),c("text",{x:10,y:e.schema.maintainers?46:31,class:"node-author","text-anchor":"start","shape-rendering":"crispEdges","text-rendering":"geometricPrecision"},Y(e.schema.authors.join(" ")),9,kn),c("text",{x:10,y:e.schema.maintainers?61:46,class:"node-date","text-anchor":"start","shape-rendering":"crispEdges","text-rendering":"geometricPrecision"},Y(je(qe)(e.schema.date)),9,_n)],42,wn)),[[ze,ve(e.schema.id)]])),128))]),j.value&&x.value?(p(),y("g",Sn,[(p(!0),y(U,null,Q(ie.value.filter(e=>e.schema.id===x.value),e=>(p(),y("g",{key:"ghost-"+e.schema.id,transform:`translate(${e.x+(H.value-F.value)}, ${e.y})`},[c("rect",{width:e.width,height:e.height,class:"ghost-bg",rx:"8"},null,8,En)],8,$n))),128))])):N("",!0),i.value?(p(),y("g",Mn,[(p(!0),y(U,null,Q(We.value,(e,C)=>{var w,I,W,D;return p(),y("g",{key:`label-${C}`,onMouseenter:$=>ce(e.connection),onMouseleave:t[11]||(t[11]=$=>ce(null)),onClick:$=>Ie(e.connection),class:he(["connection-label-group",{"label-hovered":v.value&&v.value.from===e.connection.from&&v.value.to===e.connection.to,"label-pinned":g.value&&g.value.from===e.connection.from&&g.value.to===e.connection.to,"label-dimmed":(v.value||g.value)&&!(((w=v.value)==null?void 0:w.from)===e.connection.from&&((I=v.value)==null?void 0:I.to)===e.connection.to||((W=g.value)==null?void 0:W.from)===e.connection.from&&((D=g.value)==null?void 0:D.to)===e.connection.to),"label-parent":e.connection.from===i.value&&e.connection.type!=="similar","label-child":e.connection.to===i.value&&e.connection.type!=="similar","label-similar":e.connection.type==="similar"&&(e.connection.from===i.value||e.connection.to===i.value)}])},[c("rect",{x:e.x-e.width/2,y:e.y-e.height/2,width:e.width,height:e.height,class:"connection-label-bg",rx:"4"},null,8,Fn),c("text",{x:e.x,y:e.y+4,class:"connection-label","text-anchor":"middle"},Y(e.label),9,Tn)],42,Yn)}),128))])):N("",!0)],8,sn))],512),i.value||g.value?(p(),y("div",Wn,[z.value?(p(),y("div",Nn,[c("div",In,[re(Y(z.value.name)+" ",1),z.value.url?(p(),y("a",{key:0,href:z.value.url,target:"_blank",rel:"noopener noreferrer",class:"schema-link-icon",title:"è¨ªå•ç¶²ç«™"},"ğŸ”—",8,Dn)):N("",!0)]),z.value.maintainers?(p(),y("div",Ln,Y(z.value.maintainers.join("ã€"))+" (ä¿®è¨‚ç¶­è­·) ",1)):N("",!0),c("div",Hn,Y(z.value.authors.join("ã€")),1),c("div",An,Y(je(ft)(z.value.date)),1),c("div",zn,[(p(!0),y(U,null,Q(z.value.features,e=>(p(),y("span",{key:e,class:"feature-tag"},Y(e),1))),128))]),z.value.description?(p(),y("div",jn,[t[20]||(t[20]=c("span",{class:"description-label"},null,-1)),re(Y(z.value.description),1)])):N("",!0)])):N("",!0),c("div",Pn,[g.value?(p(),y("span",Xn,"å†æ¬¡é»æ“Šç‰¹å¾µæ¨™ç±¤è§£é™¤é‡˜é¸æ¨¡å¼")):v.value?(p(),y("span",On,"é»æ“Šç‰¹å¾µæ¨™ç±¤é€²å…¥é‡˜é¸æ¨¡å¼")):(p(),y("span",qn,"å†æ¬¡é»æ“Šæ–¹æ¡ˆå¡ç‰‡è§£é™¤é—œæ³¨æ¨¡å¼"))])])):N("",!0)]))],2))}}),Un=ct(Rn,[["__scopeId","data-v-176b390a"]]);export{Un as G};
