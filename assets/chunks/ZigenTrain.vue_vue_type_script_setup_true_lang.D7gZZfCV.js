var re=Object.defineProperty;var oe=(y,t,e)=>t in y?re(y,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):y[t]=e;var q=(y,t,e)=>oe(y,typeof t!="symbol"?t+"":t,e);import{b as ne,f as se}from"./share.DVhxay46.js";import{d as ee,h as k,l as U,R as L,aa as X,k as T,v as ae,c as f,o as v,F as Y,e as M,m as n,t as O,O as le,n as $,p as A,C as ie,a3 as ce,a4 as ue,a as D,a0 as de,a2 as ge,_ as fe,E as J,H as ve}from"./framework.2ez64Ajs.js";import{f as me}from"./share._4MLh06p.js";class te{constructor(t){q(this,"items",new Map);q(this,"storageKey");q(this,"practiceCount",0);this.storageKey=`short_term_schedule_${t}`,this.loadFromStorage()}recordSuccess(t){const e=this.getOrCreateItem(t);this.practiceCount++,e.consecutiveCorrect++,e.totalReviews++,e.lastPracticed=this.practiceCount,e.consecutiveCorrect===1?e.nextReviewAfter=5:e.consecutiveCorrect===2?e.nextReviewAfter=15:e.consecutiveCorrect>=3&&(e.nextReviewAfter=e.errorCount>1?30:999),this.items.set(t,e),this.saveToStorage(),console.log(`成功記錄 ${t}: 連續正確=${e.consecutiveCorrect}, 錯誤次數=${e.errorCount}, 下次復習間隔=${e.nextReviewAfter}組`)}recordFailure(t){const e=this.getOrCreateItem(t);this.practiceCount++,e.consecutiveCorrect=0,e.totalReviews++,e.errorCount++,e.lastPracticed=this.practiceCount,e.errorCount===1?e.nextReviewAfter=2:e.errorCount===2?e.nextReviewAfter=1:e.nextReviewAfter=0,this.items.set(t,e),this.saveToStorage(),console.log(`錯誤記錄 ${t}: 錯誤次數=${e.errorCount}, 下次復習間隔=${e.nextReviewAfter}組`)}getNext(t){const e=[];for(const a of t){const c=this.items.get(a.code);if(!c)e.push({item:a,priority:1e6});else{const i=this.practiceCount-c.lastPracticed;if(i>=c.nextReviewAfter){let m=1e4;m+=c.errorCount*5e3,m+=(i-c.nextReviewAfter)*100,e.push({item:a,priority:m})}}}if(e.length===0){const a=t.filter(c=>{const i=this.items.get(c.code);return i&&i.errorCount>0&&i.consecutiveCorrect<3});return a.length>0?(a.sort((c,i)=>{const m=this.items.get(c.code);return this.items.get(i.code).errorCount-m.errorCount}),a[0]):null}return e.sort((a,c)=>c.priority-a.priority),e[0].item}getStats(){let t=0,e=0,a=0;for(const c of this.items.values())c.consecutiveCorrect>=3&&c.errorCount<=1?t++:c.errorCount>=3?a++:e++;return{total:this.items.size,mastered:t,learning:e,difficult:a}}getItemStats(t){return this.items.get(t)||null}getCurrentProgress(){const t=this.getStats(),e=t.total*3+t.difficult*2;return{practiceCount:this.practiceCount,estimatedTotal:e}}getOrCreateItem(t){const e=this.items.get(t);return e||{id:t,nextReviewAfter:0,consecutiveCorrect:0,totalReviews:0,errorCount:0,lastPracticed:0}}loadFromStorage(){try{const t=localStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);this.items=new Map(Object.entries(e.items||{})),this.practiceCount=e.practiceCount||0}}catch(t){console.warn("載入調度數據失敗:",t)}}saveToStorage(){try{const t={items:Object.fromEntries(this.items),practiceCount:this.practiceCount};localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(t){console.warn("保存調度數據失敗:",t)}}reset(){this.items.clear(),this.practiceCount=0,localStorage.removeItem(this.storageKey)}}const pe={key:0,class:"max-w-2xl mx-auto p-6 space-y-6"},xe={class:"relative"},he={class:"text-center text-sm text-gray-600 dark:text-gray-400"},ye={class:"flex justify-between items-center mb-2"},we={key:0,class:"text-red-600 dark:text-red-400"},be={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2"},ke={class:"absolute top-4 right-4 flex gap-2 z-10"},Ce=["title"],_e={class:"text-center py-12"},Se={key:0,class:"text-sm text-gray-600 dark:text-gray-300 font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded"},Re={class:"flex justify-center pb-8"},ze={class:"inline-block bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-lg"},Ie={class:"font-mono text-xl font-bold text-blue-600 dark:text-blue-400"},Me={class:"text-center text-sm text-gray-500 dark:text-gray-400 space-y-1"},Oe={key:0,class:"flex items-center justify-center gap-4"},$e={key:1,class:"text-blue-600 dark:text-blue-400 font-medium"},Ae=ee({__name:"TrainCardGroup",props:{name:{},cardGroups:{},chaifenMap:{},mode:{},supplement:{type:Boolean},ming:{type:Boolean},isFrequencyOrder:{type:Boolean},onToggleSort:{type:Function},onReset:{type:Function}},setup(y){const t=y,{name:e,cardGroups:a,mode:c,supplement:i,ming:m,isFrequencyOrder:p,onToggleSort:F,onReset:G}=t;console.log(`載入分組練習會話: ${e}`);const z=new te(e),C=k(0),I=k(),_=k(""),x=k(!1),h=k(!0),j=k(0),S=k(!1),P=()=>{S.value=!0},K=()=>{G&&(G(),S.value=!1,setTimeout(()=>{window.location.reload()},100))},l=()=>{S.value=!1},o=k(typeof window<"u"?window.innerWidth:1024),g=()=>{o.value=window.innerWidth};U(()=>{typeof window<"u"&&window.addEventListener("resize",g),L(()=>{var s;(s=I.value)==null||s.focus()}),document.addEventListener("keydown",N),V()}),X(()=>{typeof window<"u"&&window.removeEventListener("resize",g),document.removeEventListener("keydown",N)});const B=T(()=>{if(!u.value)return"text-8xl";const s=u.value.zigens.length,r=o.value<768,d=o.value<1024;return r?s<=2?"text-6xl":s<=4?"text-5xl":"text-4xl":d?s<=2?"text-8xl":s<=4?"text-7xl":"text-6xl":s<=2?"text-9xl":s<=4?"text-8xl":"text-7xl"}),w=T(()=>{if(!u.value)return"gap-8 lg:gap-12";const s=u.value.zigens.length;return o.value<768?s>4?"gap-3":"gap-4":s>4?"gap-6":"gap-8 lg:gap-12"}),u=T(()=>a[C.value]||null),R=T(()=>a.length),E=T(()=>R.value>0?(C.value/R.value*100).toFixed(1):"0");ae(_,s=>{if(!u.value)return;const r=s.trim().toLowerCase(),d=u.value.code.toLowerCase();r.length>=d.length&&(r===d?W():x.value||H())});const W=()=>{u.value&&(h.value=!0,z.recordSuccess(u.value.code),V())},H=()=>{u.value&&(h.value=!1,j.value++,x.value=!0,z.recordFailure(u.value.code),_.value="",L(()=>{var s;(s=I.value)==null||s.focus()}))},V=()=>{const s=z.getNext(a);if(s)C.value=a.findIndex(r=>r.code===s.code);else{const r=a.filter(d=>{const b=z.getItemStats(d.code);return!b||b.consecutiveCorrect<3||b.errorCount>0});if(r.length>0){const d=r[Math.floor(Math.random()*r.length)];C.value=a.findIndex(b=>b.code===d.code)}else C.value=Math.floor(Math.random()*a.length)}h.value=!0,x.value=!1,j.value=0,_.value="",L(()=>{var r;(r=I.value)==null||r.focus()})},N=s=>{s.key==="Escape"&&!x.value&&(H(),s.preventDefault())},Q=s=>{const r=me(s,t.chaifenMap),d=o.value<768,b=o.value<1024;let Z=4;return d?Z=2:b&&(Z=3),r.slice(0,Z).split("").join("")};return U(()=>{L(()=>{var s;(s=I.value)==null||s.focus()}),document.addEventListener("keydown",N),V()}),X(()=>{document.removeEventListener("keydown",N)}),(s,r)=>(v(),f(Y,null,[u.value?(v(),f("div",pe,[n("div",xe,[n("div",he,[n("div",ye,[n("span",null,"練習進度: "+O(C.value+1)+" / "+O(R.value),1),j.value>0?(v(),f("span",we,"錯誤次數: "+O(j.value),1)):M("",!0)]),n("div",be,[n("div",{class:"bg-blue-500 dark:bg-blue-400 h-2 rounded-full transition-all duration-300",style:le(`width: ${E.value}%`)},null,4)])])]),n("div",{class:$(["w-full shadow-lg rounded-2xl transition-all duration-300 transform relative",{"bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800":!h.value,"bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800":h.value},"border-2 hover:shadow-xl"])},[n("div",ke,[A(F)?(v(),f("button",{key:0,onClick:r[0]||(r[0]=()=>{console.log("排序按鈕被點擊，當前狀態:",A(p)),A(F)()}),class:$(["w-8 h-8 rounded-full font-medium transition-all duration-200 flex items-center justify-center text-xs shadow-md",A(p)?"bg-orange-500 hover:bg-orange-600 text-white":"bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200"]),title:A(p)?"字頻序 (點擊切換到字典序)":"字典序 (點擊切換到字頻序)"},[...r[3]||(r[3]=[n("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"})],-1)])],10,Ce)):M("",!0),A(G)?(v(),f("button",{key:1,onClick:P,class:"w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 text-white font-medium transition-all duration-200 flex items-center justify-center text-xs shadow-md",title:"重新開始訓練"},[...r[4]||(r[4]=[n("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1)])])):M("",!0)]),n("div",_e,[n("div",{class:$(["flex justify-center items-center flex-wrap mb-12",w.value])},[(v(!0),f(Y,null,ie(u.value.zigens,(d,b)=>(v(),f("div",{key:b,class:"flex flex-col items-center group"},[n("div",{class:$(["mb-4 zigen-font transform transition-all duration-300 group-hover:scale-110",B.value,{"text-red-500 dark:text-red-400":!h.value,"text-blue-700 dark:text-blue-300":h.value}])},O(d.font),3),x.value?(v(),f("div",Se,O(d.ma),1)):M("",!0),Q(d.font)?(v(),f("div",{key:1,class:$(["text-gray-600 dark:text-gray-300 mt-2 font-medium tracking-tight",{"text-sm":o.value<768,"text-base":o.value>=768&&o.value<1024,"text-lg":o.value>=1024}])},O(Q(d.font)),3)):M("",!0)]))),128))],2)]),n("div",Re,[ce(n("input",{ref_key:"inputElement",ref:I,"onUpdate:modelValue":r[1]||(r[1]=d=>_.value=d),type:"text",placeholder:"編碼",class:$(["px-6 py-4 text-2xl text-center border-2 rounded-xl w-48 font-mono","transition-all duration-300 focus:outline-none focus:ring-4",{"border-red-300 focus:border-red-500 focus:ring-red-200 bg-red-50 dark:border-red-700 dark:focus:border-red-500 dark:focus:ring-red-900/50 dark:bg-red-900/20 dark:text-white":!h.value,"border-blue-300 focus:border-blue-500 focus:ring-blue-200 bg-white dark:border-blue-700 dark:focus:border-blue-500 dark:focus:ring-blue-900/50 dark:bg-gray-800 dark:text-white":h.value}])},null,2),[[ue,_.value]])]),n("div",{class:$(["text-center pb-8 transition-all duration-300",{"opacity-0 transform translate-y-2":!x.value,"opacity-100":x.value}])},[n("div",ze,[r[5]||(r[5]=n("span",{class:"text-gray-800 dark:text-gray-200"},"答案是",-1)),r[6]||(r[6]=D()),n("span",Ie,O(u.value.code),1)])],2)],2),n("div",Me,[x.value?(v(),f("div",$e," 繼續輸入正確編碼 ")):(v(),f("div",Oe,[...r[7]||(r[7]=[n("span",{class:"flex items-center gap-1"},[n("kbd",{class:"px-2 py-1 text-xs bg-gray-100 dark:bg-gray-800 dark:text-gray-300 rounded"},"輸入"),D(" 自動檢查 ")],-1),n("span",{class:"flex items-center gap-1"},[n("kbd",{class:"px-2 py-1 text-xs bg-gray-100 dark:bg-gray-800 dark:text-gray-300 rounded"},"Esc"),D(" 顯示答案 ")],-1)])]))])])):M("",!0),S.value?(v(),f("div",{key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:l},[n("div",{class:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm mx-4 shadow-xl",onClick:r[2]||(r[2]=de(()=>{},["stop"]))},[r[8]||(r[8]=ge('<div class="flex items-center gap-3 mb-4" data-v-2fa078b7><div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center" data-v-2fa078b7><svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-2fa078b7><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" data-v-2fa078b7></path></svg></div><div data-v-2fa078b7><h3 class="text-lg font-medium text-gray-900 dark:text-gray-100" data-v-2fa078b7>確認重置</h3><p class="text-sm text-gray-600 dark:text-gray-400" data-v-2fa078b7>您確定要重新開始訓練嗎？</p></div></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-6" data-v-2fa078b7> 這將清除當前的學習進度和統計數據，無法恢復。 </p>',2)),n("div",{class:"flex gap-3 justify-end"},[n("button",{onClick:l,class:"px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"}," 取消 "),n("button",{onClick:K,class:"px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors"}," 確認重置 ")])])])):M("",!0)],64))}}),Fe=fe(Ae,[["__scopeId","data-v-2fa078b7"]]),je={key:0},Be={key:1,class:"text-gray-700 dark:text-gray-300 text-center"},Ne=ee({__name:"ZigenTrain",props:{name:{},zigenUrl:{},range:{},mode:{},supplement:{type:Boolean},ming:{type:Boolean}},setup(y){const t=y;let e=t.name+"_zigen_grouped";const a=t.range;a&&(e+=`_${a[0]}_${a[1]}`);const c=`zigen_sort_order_${t.name}`,i=k(!1),m=J(),p=J(),F=J();function G(){try{const l=localStorage.getItem(c);if(l!==null){const o=JSON.parse(l);i.value=o,console.log("載入保存的排序狀態:",o)}}catch(l){console.warn("載入排序狀態失敗:",l)}}function z(){try{localStorage.setItem(c,JSON.stringify(i.value)),console.log("排序狀態已保存:",i.value)}catch(l){console.warn("保存排序狀態失敗:",l)}}const C=["口","一","月","丶","日","人","亻","扌","白","土","丷","二","又","丿","宀","木","尚","辶","小","冖","厶","心","氵","八","女","大","艹","𠂇","匕","寸","也","乙","戈","目","讠","不","龰","阝","竹","了","十","夂","王","刂","儿","力","凵","冂","子","斤","火","米","丁","彐","纟","文","立","士","夕","乂","门","卜","自","尤","彳","羊","止","禾","贝","尸","工","乚","上","囗","至","手","𬺰","艮","车","石","田","己","几","牛","见","走","甲","且","彡","犬","巾","西","方","刀","殳","七","弓","巴","矢","示"],I=["鳥","烏","魚","馬","風","來","車","長","門","鬥","齒","飛","見","貝","鹵","僉","韋","咼","黽"],_=l=>{switch(t.mode){case"A":return l[0];case"a":return l[1];case"both":return l}};function x(l){for(const o of l.zigens){const g=C.indexOf(o.font);if(g!==-1)return g}for(const o of l.zigens){const g=I.indexOf(o.font);if(g!==-1)return 1e4+g}return 5e3}function h(l){return[...l].sort((o,g)=>{const B=x(o),w=x(g);return B-w})}function j(){console.log("切換排序模式被調用，當前狀態:",i.value),i.value=!i.value,console.log("切換後狀態:",i.value),z(),S(),console.log("排序應用完成，按鈕應該顯示為:",i.value?"橙色（字頻序）":"灰色（字典序）"),setTimeout(()=>{window.location.reload()},100)}function S(){m.value?(i.value?(p.value=h(m.value),console.log("已切換到字頻序，重新排序了",p.value.length,"個字根組")):(p.value=[...m.value],console.log("已切換到字典序，恢復原始順序")),L(()=>{console.log("排序更新完成，當前順序:",p.value.slice(0,3).map(l=>l.code))})):console.warn("originalCardGroups 未初始化，無法應用排序")}function P(l){var g,B;const o=[];for(let w=0;w<l.length;w++){const u=l[w],R=(g=_(u.ma))==null?void 0:g.toLowerCase();if(!R)continue;const E=w>0?l[w-1]:null;(E?(B=_(E.ma))==null?void 0:B.toLowerCase():null)===R&&o.length>0&&o[o.length-1].code===R?o[o.length-1].zigens.push(u):o.push({code:R,zigens:[u]})}return o}function K(){m.value&&(new te(e).reset(),i.value=!1,z(),S(),console.log("訓練已重置，排序狀態重置為字典序"))}return U(async()=>{G(),F.value=await ne("/chaifen.csv");let o=[...(await se(t.zigenUrl)).values()];a&&(o=o.slice(a[0],a[1]));const g=P(o);m.value=g,S(),console.log(`字根練習：共 ${g.length} 個編碼組，包含 ${o.length} 個字根，當前${i.value?"字頻序":"字典序"}`)}),(l,o)=>p.value&&F.value?(v(),f("div",je,[ve(Fe,{name:A(e),"card-groups":p.value,"chaifen-map":F.value,mode:"g",supplement:t.supplement??!1,ming:t.ming??!1,"is-frequency-order":i.value,"on-toggle-sort":j,"on-reset":K},null,8,["name","card-groups","chaifen-map","supplement","ming","is-frequency-order"])])):(v(),f("h2",Be," 下載資料中…… "))}});export{Ne as _};
