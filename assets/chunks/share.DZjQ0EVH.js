var b=Object.defineProperty;var x=(r,t,s)=>t in r?b(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var g=(r,t,s)=>x(r,typeof t!="symbol"?t+"":t,s);import{g as U}from"./framework.D5VGNaZP.js";const u=class u{constructor(t){g(this,"data",null);g(this,"loading",null);g(this,"dataUrl");g(this,"pakoLoaded",!1);this.dataUrl=t}async loadPako(){if(window.pako||this.pakoLoaded)return window.pako;try{const t=document.createElement("script");return t.src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js",t.crossOrigin="anonymous",await new Promise((s,n)=>{t.onload=s,t.onerror=n,document.head.appendChild(t)}),this.pakoLoaded=!0,window.pako}catch(t){return console.warn("Failed to load pako library:",t),null}}static getInstance(t="/chaifen.json"){return u.instances.has(t)||u.instances.set(t,new u(t)),u.instances.get(t)}async loadData(){return this.data?this.data:this.loading?this.loading:(this.loading=this.fetchOptimizedData(),this.data=await this.loading,this.loading=null,this.data)}async fetchOptimizedData(){const t=performance.now(),n=[{url:this.dataUrl.replace(".csv",".json"),compressed:!0},{url:this.dataUrl,compressed:!1,csv:!0}];for(const e of n)try{const a=await fetch(e.url,{headers:{Accept:"application/json, text/csv, */*","Accept-Charset":"utf-8"}});if(!a.ok)continue;let o;if(e.csv){const l=await a.arrayBuffer(),i=new TextDecoder("utf-8").decode(l);o=this.parseCsvToOptimized(i)}else if(e.compressed){const l=await a.arrayBuffer(),i=await this.decompressGzip(l),c=new TextDecoder("utf-8").decode(i);o=JSON.parse(c)}else{const l=await a.arrayBuffer(),i=new TextDecoder("utf-8").decode(l);o=JSON.parse(i)}const d=performance.now()-t;return console.log(`üìä Loaded ${e.url} in ${d.toFixed(2)}ms`),console.log(`üì¶ Data contains ${Object.keys(o).length} characters`),o}catch(a){console.warn(`Failed to load ${e.url}:`,a);continue}throw new Error("Failed to load chaifen data from any source")}parseCsvToOptimized(t){const s=t.split(`
`),n={};for(let e=1;e<s.length;e++){const a=s[e].trim();if(!a)continue;const[o,d,l,i]=a.split(",");if(o){const c={};d&&(c.d=d),l&&(c.dt=l),i&&(c.r=i),n[o]=c}}return n}search(t){var e,a;if(!this.data)return console.warn("Data not loaded yet"),[];const s=[],n=t.toLowerCase();if(t.length===1&&this.data[t]){const o=this.data[t];s.push({char:t,division:o.d,division_tw:o.dt,region:o.r})}for(const[o,d]of Object.entries(this.data))(o.includes(n)||(e=d.d)!=null&&e.toLowerCase().includes(n)||(a=d.dt)!=null&&a.toLowerCase().includes(n))&&s.push({char:o,division:d.d,division_tw:d.dt,region:d.r});return s}getChar(t){if(!this.data||!this.data[t])return null;const s=this.data[t];return{char:t,division:s.d,division_tw:s.dt,region:s.r}}async decompressGzip(t){try{const s=await this.loadPako();if(s){console.log("üì¶ Using pako for gzip decompression");const c=new Uint8Array(t);return s.inflate(c).buffer}if(console.log("üåê Using browser DecompressionStream for gzip decompression"),typeof DecompressionStream>"u")throw new Error("DecompressionStream not supported and pako not available");const e=new ReadableStream({start(c){c.enqueue(new Uint8Array(t)),c.close()}}).pipeThrough(new DecompressionStream("gzip")),a=[],o=e.getReader();for(;;){const{done:c,value:h}=await o.read();if(c)break;a.push(h)}const d=a.reduce((c,h)=>c+h.length,0),l=new Uint8Array(d);let i=0;for(const c of a)l.set(c,i),i+=c.length;return l.buffer}catch(s){throw console.error("Failed to decompress gzip data:",s),new Error(`Gzip decompression failed: ${s.message}`)}}};g(u,"instances",new Map);let k=u,m={};function A(r,t,s,n){var a,o,d,l,i,c,h,D,S,j;const e=[...r];if(n){let f=[];const p=e[0],y=e[e.length-1];e.length==1?f.push((((o=(a=t.get(p))==null?void 0:a.ma)==null?void 0:o[0])||"?").toUpperCase()):f.push((((l=(d=t.get(p))==null?void 0:d.ma)==null?void 0:l.slice(0,-1))||"?").toUpperCase()),f.push(...e.slice(1).map(w=>{var L,O;return(((O=(L=t.get(w))==null?void 0:L.ma)==null?void 0:O[0])||"?").toUpperCase()}));const v=w=>w.length===2?w[0].toUpperCase()+w[1]:w;return f.push(v(((c=(i=t.get(y))==null?void 0:i.ma)==null?void 0:c.slice(1))||"?")),f.join("").slice(0,5)}else{let f=e.map(p=>{var y,v;return((v=(y=t.get(p))==null?void 0:y.ma)==null?void 0:v[0])||"?"});if(f.length<4){const p=e[e.length-1];f.push(((D=(h=t.get(p))==null?void 0:h.ma)==null?void 0:D[1])||"?")}if(f.length<4&&s){const p=e[0];f.push(((j=(S=t.get(p))==null?void 0:S.ma)==null?void 0:j[1])||"?")}return f.join("")}}async function C(r){if(r in m)return m[r];try{const s=await(await fetch(U(r))).text(),n=$(s);return m[r]=n,n}catch(t){throw t instanceof Error&&alert(`Êó†Ê≥ï‰∏ãËΩΩÊàñËß£Êûê„Ää${r}„ÄãÊñá‰ª∂Ôºö${t.cause}`),t}}function $(r){const t=r.split(`
`),n=t.shift().split(",").map(o=>o.trim()),e=n.length,a=new Map;for(let o of t){if(o=o.trim(),!o)continue;const d=o.split(",").map(i=>i.trim());if(d.length!==e)throw new Error(`CSVÊñá‰ª∂‰∏≠ ${o} Êï∞ÊçÆ‰∏çÂ§ü ${e} Êù°„ÄÇ`);const l={};for(let i=0;i<e;i++)l[n[i]]=d[i];a.set(d[0],l)}return a}async function B(r){return await C(r)}async function E(r){return await C(r)}async function F(r){const t=`optimized_${r}`;if(t in m)return m[t];try{const n=await k.getInstance(r).loadData(),e=new Map;for(const[a,o]of Object.entries(n))e.set(a,{char:a,division:o.d||"",division_tw:o.dt||"",region:o.r||""});return console.log(`‚úÖ ÊàêÂäü‰ΩøÁî®ÂéãÁº©JSONÊ†ºÂºèÂä†ËΩΩÊãÜÂàÜÊï∞ÊçÆ: ${e.size} ‰∏™Â≠óÁ¨¶`),m[t]=e,e}catch(s){console.warn("JSONÊ†ºÂºèÂä†ËΩΩÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞CSVÊ†ºÂºè:",s);try{const n=await C(r);return console.log(`‚ö†Ô∏è ‰ΩøÁî®CSVÊ†ºÂºèÂä†ËΩΩÊãÜÂàÜÊï∞ÊçÆ: ${n.size} ‰∏™Â≠óÁ¨¶`),m[t]=n,n}catch(n){throw console.error("CSVÊ†ºÂºè‰πüÂä†ËΩΩÂ§±Ë¥•:",n),n}}}export{k as C,C as a,B as b,F as c,m as d,E as f,A as m};
