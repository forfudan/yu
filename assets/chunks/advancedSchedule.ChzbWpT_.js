var o=Object.defineProperty;var c=(s,t,e)=>t in s?o(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var i=(s,t,e)=>c(s,typeof t!="symbol"?t+"":t,e);class l{constructor(t){i(this,"items",new Map);i(this,"storageKey");i(this,"currentLearningIndex",0);i(this,"practiceCounter",0);i(this,"totalGroups",0);i(this,"INITIAL_INTERVALS",[2,5,10]);i(this,"REINFORCE_INTERVAL",1);i(this,"MAX_INTERVAL",20);i(this,"GRADUATION_THRESHOLD",3);this.storageKey=`advanced_schedule_${t}`,this.loadFromStorage()}initializeWithGroupCount(t){this.totalGroups=t;for(let e=0;e<t;e++)this.items.has(e)||this.items.set(e,{index:e,consecutiveCorrect:0,totalReviews:0,isCompleted:!1,nextReviewAt:0,currentInterval:0,lastPracticedAt:0});this.saveToStorage()}recordSuccess(t){const e=this.getOrCreateItem(t);this.practiceCounter++,e.consecutiveCorrect++,e.totalReviews++,e.lastPracticedAt=this.practiceCounter,e.consecutiveCorrect>=this.GRADUATION_THRESHOLD?(e.isCompleted=!0,e.nextReviewAt=Number.MAX_SAFE_INTEGER):this.scheduleNextReview(e),this.saveToStorage()}recordFailure(t){const e=this.getOrCreateItem(t);this.practiceCounter++,e.consecutiveCorrect=0,e.totalReviews++,e.lastPracticedAt=this.practiceCounter,e.currentInterval=this.REINFORCE_INTERVAL,e.nextReviewAt=this.practiceCounter+this.REINFORCE_INTERVAL,this.saveToStorage()}scheduleNextReview(t){const e=t.consecutiveCorrect;e<=this.INITIAL_INTERVALS.length?t.currentInterval=this.INITIAL_INTERVALS[e-1]:t.currentInterval=Math.min(Math.floor(t.currentInterval*1.5),this.MAX_INTERVAL),t.nextReviewAt=this.practiceCounter+t.currentInterval}getNextIndex(){const t=this.getDueItems();if(t.length>0)return t[0].index;for(;this.currentLearningIndex<this.totalGroups;){const e=this.items.get(this.currentLearningIndex);if(!e||!e.isCompleted){const r=this.currentLearningIndex;return this.currentLearningIndex++,r}this.currentLearningIndex++}for(const[e,r]of this.items.entries())if(!r.isCompleted)return e;return null}getDueItems(){const t=[];for(const e of this.items.values())!e.isCompleted&&e.nextReviewAt>0&&this.practiceCounter>=e.nextReviewAt&&t.push(e);return t.sort((e,r)=>{if(e.consecutiveCorrect===0&&r.consecutiveCorrect>0)return-1;if(r.consecutiveCorrect===0&&e.consecutiveCorrect>0)return 1;const n=this.practiceCounter-e.nextReviewAt;return this.practiceCounter-r.nextReviewAt-n}),t}isFirstTime(t){const e=this.items.get(t);return!e||e.totalReviews===0}isCompleted(){if(this.totalGroups===0)return!1;for(let t=0;t<this.totalGroups;t++){const e=this.items.get(t);if(!e||!e.isCompleted)return!1}return!0}getOrCreateItem(t){let e=this.items.get(t);return e||(e={index:t,consecutiveCorrect:0,totalReviews:0,isCompleted:!1,nextReviewAt:0,currentInterval:0,lastPracticedAt:0},this.items.set(t,e)),e}getProgressStats(){let t=0,e=0;for(let r=0;r<this.totalGroups;r++)this.items.has(r)||this.items.set(r,{index:r,consecutiveCorrect:0,totalReviews:0,isCompleted:!1,nextReviewAt:0,currentInterval:0,lastPracticedAt:0});for(const r of this.items.values())r.totalReviews>0&&t++,r.isCompleted&&e++;return{practiced:t,mastered:e,total:this.totalGroups,percentage:this.totalGroups>0?t/this.totalGroups*100:0}}reset(){this.items.clear(),this.currentLearningIndex=0,this.practiceCounter=0;for(let t=0;t<this.totalGroups;t++)this.items.set(t,{index:t,consecutiveCorrect:0,totalReviews:0,isCompleted:!1,nextReviewAt:0,currentInterval:0,lastPracticedAt:0});typeof localStorage<"u"&&localStorage.removeItem(this.storageKey)}getScheduleDebugInfo(){const t=Array.from(this.items.values()).filter(r=>r.isCompleted).length,e=this.getDueItems().length;return`練習計數: ${this.practiceCounter}, 到期項目: ${e}, 當前學習索引: ${this.currentLearningIndex}/${this.totalGroups}, 已完成: ${t}`}saveToStorage(){if(typeof localStorage<"u"){const t={items:Array.from(this.items.entries()),currentLearningIndex:this.currentLearningIndex,practiceCounter:this.practiceCounter,totalGroups:this.totalGroups};localStorage.setItem(this.storageKey,JSON.stringify(t))}}loadFromStorage(){if(typeof localStorage<"u"){const t=localStorage.getItem(this.storageKey);if(t)try{const e=JSON.parse(t);this.items=new Map(e.items||[]),this.currentLearningIndex=e.currentLearningIndex||0,this.practiceCounter=e.practiceCounter||0,this.totalGroups=e.totalGroups||0}catch(e){console.warn("載入存儲數據失敗:",e)}}}}export{l as A};
