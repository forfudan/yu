var j=Object.defineProperty;var F=(m,t,e)=>t in m?j(m,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[t]=e;var R=(m,t,e)=>F(m,typeof t!="symbol"?t+"":t,e);import{b as K,f as D}from"./share.DVhxay46.js";import{d as N,h as k,k as A,v as U,l as O,R as $,aa as V,c as h,e as S,o as v,m as n,t as _,O as Z,n as I,F as J,C as W,a3 as q,a4 as H,a as M,_ as Q,E as L,b as X,p as Y}from"./framework.2ez64Ajs.js";import{f as ee}from"./share.D8r7Ijln.js";class te{constructor(t){R(this,"items",new Map);R(this,"storageKey");R(this,"practiceCount",0);this.storageKey=`short_term_schedule_${t}`,this.loadFromStorage()}recordSuccess(t){const e=this.getOrCreateItem(t);this.practiceCount++,e.consecutiveCorrect++,e.totalReviews++,e.lastPracticed=this.practiceCount,e.consecutiveCorrect===1?e.nextReviewAfter=5:e.consecutiveCorrect===2?e.nextReviewAfter=15:e.consecutiveCorrect>=3&&(e.nextReviewAfter=e.errorCount>1?30:999),this.items.set(t,e),this.saveToStorage(),console.log(`成功記錄 ${t}: 連續正確=${e.consecutiveCorrect}, 錯誤次數=${e.errorCount}, 下次復習間隔=${e.nextReviewAfter}組`)}recordFailure(t){const e=this.getOrCreateItem(t);this.practiceCount++,e.consecutiveCorrect=0,e.totalReviews++,e.errorCount++,e.lastPracticed=this.practiceCount,e.errorCount===1?e.nextReviewAfter=2:e.errorCount===2?e.nextReviewAfter=1:e.nextReviewAfter=0,this.items.set(t,e),this.saveToStorage(),console.log(`錯誤記錄 ${t}: 錯誤次數=${e.errorCount}, 下次復習間隔=${e.nextReviewAfter}組`)}getNext(t){const e=[];for(const r of t){const s=this.items.get(r.code);if(!s)e.push({item:r,priority:1e6});else{const u=this.practiceCount-s.lastPracticed;if(u>=s.nextReviewAfter){let g=1e4;g+=s.errorCount*5e3,g+=(u-s.nextReviewAfter)*100,e.push({item:r,priority:g})}}}if(e.length===0){const r=t.filter(s=>{const u=this.items.get(s.code);return u&&u.errorCount>0&&u.consecutiveCorrect<3});return r.length>0?(r.sort((s,u)=>{const g=this.items.get(s.code);return this.items.get(u.code).errorCount-g.errorCount}),r[0]):null}return e.sort((r,s)=>s.priority-r.priority),e[0].item}getStats(){let t=0,e=0,r=0;for(const s of this.items.values())s.consecutiveCorrect>=3&&s.errorCount<=1?t++:s.errorCount>=3?r++:e++;return{total:this.items.size,mastered:t,learning:e,difficult:r}}getItemStats(t){return this.items.get(t)||null}getCurrentProgress(){const t=this.getStats(),e=t.total*3+t.difficult*2;return{practiceCount:this.practiceCount,estimatedTotal:e}}getOrCreateItem(t){const e=this.items.get(t);return e||{id:t,nextReviewAfter:0,consecutiveCorrect:0,totalReviews:0,errorCount:0,lastPracticed:0}}loadFromStorage(){try{const t=localStorage.getItem(this.storageKey);if(t){const e=JSON.parse(t);this.items=new Map(Object.entries(e.items||{})),this.practiceCount=e.practiceCount||0}}catch(t){console.warn("載入調度數據失敗:",t)}}saveToStorage(){try{const t={items:Object.fromEntries(this.items),practiceCount:this.practiceCount};localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(t){console.warn("保存調度數據失敗:",t)}}reset(){this.items.clear(),this.practiceCount=0,localStorage.removeItem(this.storageKey)}}const re={key:0,class:"max-w-2xl mx-auto p-6 space-y-6"},se={class:"text-center text-sm text-gray-600"},oe={class:"flex justify-between items-center mb-2"},ne={key:0,class:"text-red-600"},ae={class:"w-full bg-gray-200 rounded-full h-2"},ce={class:"text-center py-12"},ie={class:"flex justify-center items-center flex-wrap gap-8 lg:gap-12 mb-12"},le={key:0,class:"text-sm text-gray-600 font-mono bg-gray-100 px-2 py-1 rounded"},ue={key:1,class:"text-lg sm:text-xl text-gray-600 mt-3 font-medium"},de={class:"flex justify-center pb-8"},pe={class:"inline-block bg-gray-100 px-4 py-2 rounded-lg"},fe={class:"font-mono text-xl font-bold text-blue-600"},me={class:"text-center text-sm text-gray-500 space-y-1"},ve={key:0,class:"flex items-center justify-center gap-4"},ge={key:1,class:"text-blue-600 font-medium"},he=N({__name:"TrainCardGroup",props:{name:{},cardGroups:{},chaifenMap:{},mode:{},supplement:{type:Boolean},ming:{type:Boolean}},setup(m){const t=m,{name:e,cardGroups:r,mode:s,supplement:u,ming:g}=t;console.log(`載入分組練習會話: ${e}`);const y=new te(e),c=k(0),a=k(),x=k(""),f=k(!1),l=k(!0),C=k(0),d=A(()=>r[c.value]||null),b=A(()=>r.length),B=A(()=>b.value>0?(c.value/b.value*100).toFixed(1):"0");U(x,i=>{if(!d.value)return;const o=i.trim().toLowerCase(),p=d.value.code.toLowerCase();o.length>=p.length&&(o===p?P():f.value||G())});const P=()=>{d.value&&(l.value=!0,y.recordSuccess(d.value.code),T())},G=()=>{d.value&&(l.value=!1,C.value++,f.value=!0,y.recordFailure(d.value.code),x.value="",$(()=>{var i;(i=a.value)==null||i.focus()}))},T=()=>{const i=y.getNext(r);if(i)c.value=r.findIndex(o=>o.code===i.code);else{const o=r.filter(p=>{const w=y.getItemStats(p.code);return!w||w.consecutiveCorrect<3||w.errorCount>0});if(o.length>0){const p=o[Math.floor(Math.random()*o.length)];c.value=r.findIndex(w=>w.code===p.code)}else c.value=Math.floor(Math.random()*r.length)}l.value=!0,f.value=!1,C.value=0,x.value="",$(()=>{var o;(o=a.value)==null||o.focus()})},E=i=>{i.key==="Escape"&&!f.value&&(G(),i.preventDefault())},z=i=>ee(i,t.chaifenMap).slice(0,4).split("").join(" ");return O(()=>{$(()=>{var i;(i=a.value)==null||i.focus()}),document.addEventListener("keydown",E),T()}),V(()=>{document.removeEventListener("keydown",E)}),(i,o)=>d.value?(v(),h("div",re,[n("div",se,[n("div",oe,[n("span",null,"練習進度: "+_(c.value+1)+" / "+_(b.value),1),C.value>0?(v(),h("span",ne,"錯誤次數: "+_(C.value),1)):S("",!0)]),n("div",ae,[n("div",{class:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:Z(`width: ${B.value}%`)},null,4)])]),n("div",{class:I(["w-full shadow-lg rounded-2xl transition-all duration-300 transform",{"bg-red-50 border-red-200":!l.value,"bg-blue-50 border-blue-200":l.value},"border-2 hover:shadow-xl"])},[n("div",ce,[n("div",ie,[(v(!0),h(J,null,W(d.value.zigens,(p,w)=>(v(),h("div",{key:w,class:"flex flex-col items-center group"},[n("div",{class:I(["mb-4 zigen-font transform transition-all duration-300 group-hover:scale-110","text-7xl sm:text-8xl lg:text-9xl",{"text-red-500":!l.value,"text-blue-700":l.value}])},_(p.font),3),f.value?(v(),h("div",le,_(p.ma),1)):S("",!0),z(p.font)?(v(),h("div",ue,_(z(p.font)),1)):S("",!0)]))),128))])]),n("div",de,[q(n("input",{ref_key:"inputElement",ref:a,"onUpdate:modelValue":o[0]||(o[0]=p=>x.value=p),type:"text",placeholder:"編碼",class:I(["px-6 py-4 text-2xl text-center border-2 rounded-xl w-48 font-mono","transition-all duration-300 focus:outline-none focus:ring-4",{"border-red-300 focus:border-red-500 focus:ring-red-200 bg-red-50":!l.value,"border-blue-300 focus:border-blue-500 focus:ring-blue-200 bg-white":l.value}])},null,2),[[H,x.value]])]),n("div",{class:I(["text-center pb-8 transition-all duration-300",{"opacity-0 transform translate-y-2":!f.value,"opacity-100":f.value}])},[n("div",pe,[o[1]||(o[1]=M(" 答案是 ",-1)),n("span",fe,_(d.value.code),1)])],2)],2),n("div",me,[f.value?(v(),h("div",ge," 繼續輸入正確編碼 ")):(v(),h("div",ve,[...o[2]||(o[2]=[n("span",{class:"flex items-center gap-1"},[n("kbd",{class:"px-2 py-1 text-xs bg-gray-100 rounded"},"輸入"),M(" 自動檢查 ")],-1),n("span",{class:"flex items-center gap-1"},[n("kbd",{class:"px-2 py-1 text-xs bg-gray-100 rounded"},"Esc"),M(" 顯示答案 ")],-1)])]))])])):S("",!0)}}),xe=Q(he,[["__scopeId","data-v-836db175"]]),Ce={key:1,class:"text-gray-700 text-center"},ke=N({__name:"ZigenTrain",props:{name:{},zigenUrl:{},range:{},mode:{},supplement:{type:Boolean},ming:{type:Boolean}},setup(m){const t=m;let e=t.name+"_zigen_grouped";const r=t.range;r&&(e+=`_${r[0]}_${r[1]}`);const s=L(),u=L(),g=c=>{switch(t.mode){case"A":return c[0];case"a":return c[1];case"both":return c}};function y(c){var x,f;const a=[];for(let l=0;l<c.length;l++){const C=c[l],d=(x=g(C.ma))==null?void 0:x.toLowerCase();if(!d)continue;const b=l>0?c[l-1]:null;(b?(f=g(b.ma))==null?void 0:f.toLowerCase():null)===d&&a.length>0&&a[a.length-1].code===d?a[a.length-1].zigens.push(C):a.push({code:d,zigens:[C]})}return a}return O(async()=>{if(s.value&&u.value)return;u.value=await K("/chaifen.csv");let a=[...(await D(t.zigenUrl)).values()];r&&(a=a.slice(r[0],r[1])),s.value=y(a),console.log(`字根練習：共 ${s.value.length} 個編碼組，包含 ${a.length} 個字根`)}),(c,a)=>s.value&&u.value?(v(),X(xe,{key:0,name:Y(e),"card-groups":s.value,"chaifen-map":u.value,mode:"g",supplement:t.supplement??!1,ming:t.ming??!1},null,8,["name","card-groups","chaifen-map","supplement","ming"])):(v(),h("h2",Ce," 下載資料中…… "))}});export{ke as _};
